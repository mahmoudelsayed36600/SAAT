<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام التحصيلي الذكي | مدارس التعلم ثنائي اللغة </title>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        :root {
            --primary-color: #1e3c72;
            --secondary-color: #2a5298;
            --accent-color: #ffd700;
            --text-light: #f8f9fa;
            --bg-body: #f4f7f6;
            --card-shadow: 0 10px 20px rgba(0,0,0,0.05);
            --sidebar-width: 260px;
        }

        body {
            font-family: 'Segoe UI', 'Tajawal', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-body);
            overflow-x: hidden;
            margin: 0;
            user-select: none;
        }

        /* --- Sidebar --- */
        .sidebar {
            position: fixed; top: 0; right: 0; width: var(--sidebar-width); height: 100vh;
            background: linear-gradient(180deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: var(--text-light);
            box-shadow: 4px 0 15px rgba(0,0,0,0.1);
            z-index: 1000; display: flex; flex-direction: column; transition: all 0.3s ease;
        }
        .sidebar-header { padding: 25px; text-align: center; background: rgba(0,0,0,0.1); border-bottom: 1px solid rgba(255,255,255,0.1); }
        .sidebar-brand-icon { font-size: 2.5rem; margin-bottom: 10px; color: var(--accent-color); }
        .sidebar-menu { padding: 20px 0; flex-grow: 1; overflow-y: auto; }
        .nav-link {
            color: rgba(255,255,255,0.8); padding: 12px 25px; font-size: 1rem;
            border-right: 4px solid transparent; transition: all 0.3s; display: flex; align-items: center; cursor: pointer;
        }
        .nav-link i { width: 30px; font-size: 1.1rem; text-align: center; margin-left: 10px; }
        .nav-link:hover, .nav-link.active { color: #fff; background: rgba(255,255,255,0.1); border-right-color: var(--accent-color); }
        .sidebar-footer { padding: 20px; border-top: 1px solid rgba(255,255,255,0.1); }

        /* --- Main Content --- */
        .main-content { margin-right: var(--sidebar-width); padding: 30px; min-height: 100vh; transition: margin-right 0.3s ease; }
        .top-navbar {
            background: #fff; padding: 15px 30px; border-radius: 15px; box-shadow: var(--card-shadow);
            margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center;
        }
        .card { border: none; border-radius: 15px; box-shadow: var(--card-shadow); background: #fff; margin-bottom: 25px; overflow: hidden; }
        .card-header-custom { padding: 20px; border-bottom: 1px solid #eee; background: #fff; display: flex; justify-content: space-between; align-items: center; }
        .card-header-custom h5 { margin: 0; color: var(--primary-color); font-weight: 600; }
        
        /* Stats Cards */
        .stat-card { padding: 25px; border-radius: 15px; color: #fff; position: relative; overflow: hidden; transition: transform 0.3s; }
        .stat-card:hover { transform: translateY(-5px); }
        .stat-card.blue { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .stat-card.green { background: linear-gradient(135deg, #2af598 0%, #009efd 100%); }
        .stat-card.orange { background: linear-gradient(135deg, #f6d365 0%, #fda085 100%); }
        .stat-card.purple { background: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%); }
        .stat-icon { position: absolute; left: 15px; bottom: 15px; font-size: 3rem; opacity: 0.2; }

        /* Report Charts */
        .report-chart-container { position: relative; height: 200px; width: 100%; display: flex; justify-content: center; }
        .full-chart-container { position: relative; height: 450px; width: 100%; }

        /* Struct Tabs */
        .custom-tabs .nav-link {
            background-color: #e9ecef; color: var(--primary-color);
            margin-left: 5px; font-weight: 600; border-radius: 5px;
        }
        .custom-tabs .nav-link.active { background-color: var(--primary-color); color: #fff; }

        /* Login */
        .login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            z-index: 9999; display: flex; justify-content: center; align-items: center;
        }
        .login-box { background: white; padding: 50px; border-radius: 20px; width: 400px; box-shadow: 0 20px 50px rgba(0,0,0,0.3); text-align: center; }

        .hidden { display: none !important; }
        
        /* Custom Inputs for Grading */
        .max-score-input {
            border: 2px dashed #2a5298; color: #2a5298; font-weight: bold; background-color: #f8f9fa;
        }
        .absent-row { background-color: #f8d7da !important; opacity: 0.7; }
        .absent-row input[type="text"] { pointer-events: none; background-color: #e9ecef; }
        
        /* New Style for individual absences */
        .abs-input {
            background-color: #ffebee !important;
            color: #d32f2f !important;
            font-weight: bold;
        }
        .input-group-text { padding: 0.25rem 0.5rem; }

        /* Loader & Toasts */
        #dbLoader { margin-top: 10px; font-size: 0.9rem; color: #666; display: none; }
        
        #toast-container {
            position: fixed; bottom: 20px; left: 20px; z-index: 10000;
        }
        .toast-msg {
            background: #333; color: #fff; padding: 12px 24px; border-radius: 8px;
            margin-top: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex; align-items: center; gap: 10px; min-width: 250px;
            animation: slideIn 0.3s ease-out;
        }
        .toast-msg.success { background: #198754; border-right: 5px solid #0f5132; }
        .toast-msg.error { background: #dc3545; border-right: 5px solid #842029; }
        .toast-msg.info { background: #0d6efd; border-right: 5px solid #0a58ca; }
        
        @keyframes slideIn {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Password Toggle Icon */
        .password-toggle-icon {
            position: absolute; top: 50%; left: 15px; transform: translateY(-50%);
            cursor: pointer; z-index: 10; color: #1e3c72; padding: 5px;
        }
        
        .user-action-link {
            color: #ffd700; cursor: pointer; font-size: 0.8rem; text-decoration: underline;
        }
        .user-action-link:hover { color: #fff; }

        .clickable-status {
            cursor: pointer;
            text-decoration: underline;
            color: #dc3545;
            font-weight: bold;
        }
        .clickable-status:hover {
            color: #a71d2a;
        }

        @media print {
            .no-print, .sidebar, .btn, .nav-tabs, #toast-container { display: none !important; }
            .main-content { margin-right: 0; width: 100%; padding: 0; }
            .card { box-shadow: none; border: 1px solid #ddd; page-break-inside: avoid; }
            table { width: 100%; font-size: 12px; border-collapse: collapse; }
            th, td { border: 1px solid #000 !important; padding: 5px !important; }
            .col-md-3, .col-md-2, .col-md-4 { width: 33% !important; float: right; }
            body { 
                background-color: #fff; 
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            .bg-success { background-color: #d1e7dd !important; }
            .bg-danger { background-color: #f8d7da !important; }
            .bg-warning { background-color: #fff3cd !important; }
        }
    </style>
</head>
<body oncontextmenu="return false;">

    <div id="toast-container"></div>

    <div id="loginSection" class="login-overlay">
        <div class="login-box">
            <div class="mb-4 text-primary"><i class="fas fa-school fa-4x"></i></div>
            <h3 class="fw-bold mb-2">مدارس التعلم ثنائي اللغةالعقيق</h3>
            <p class="text-muted mb-4">نظام التحصيلي الذكي (Cloud)</p>
            <form onsubmit="event.preventDefault(); window.login();">
                <div class="form-floating mb-3 text-start">
                    <input type="text" id="username" class="form-control" placeholder="اسم المستخدم" required>
                    <label>اسم المستخدم</label>
                </div>
                <div class="form-floating mb-4 text-start position-relative">
                    <input type="password" id="password" class="form-control" placeholder="كلمة المرور" required>
                    <label>كلمة المرور</label>
                    <span class="password-toggle-icon" onclick="window.toggleLoginPassword()">
                        <i class="fas fa-eye" id="togglePasswordIcon"></i>
                    </span>
                </div>
                <button type="submit" id="loginBtn" class="btn btn-primary w-100 py-2 fw-bold">تسجيل الدخول</button>
                <div id="dbLoader"><i class="fas fa-spinner fa-spin"></i> جاري الاتصال...</div>
            </form>
        </div>
    </div>

    <div id="mainSystem" class="container-fluid p-0 hidden">
        
        <aside class="sidebar no-print">
            <div class="sidebar-header">
                <div class="sidebar-brand-icon"><i class="fas fa-graduation-cap"></i></div>
                <h5 class="m-0 fw-bold">مدارس التعلم ثنائي اللغة العقيق</h5>
                <small class="text-white-50">نظام التحصيلي</small>
            </div>
            <div class="sidebar-menu" id="sidebarMenu"></div>
            <div class="sidebar-footer">
                <div class="d-flex align-items-center mb-3">
                    <div class="user-avatar ms-2 bg-white text-primary rounded-circle p-2"><i class="fas fa-user"></i></div>
                    <div style="line-height: 1.2;">
                        <div class="fw-bold small" id="userNameDisplay">المستخدم</div>
                        <small class="text-warning d-block" id="userRoleDisplay">الدور</small>
                        <div class="mt-1">
                            <span class="user-action-link" onclick="window.openProfileModal()"><i class="fas fa-key"></i> تغيير كلمة المرور</span>
                        </div>
                    </div>
                </div>
                <button onclick="window.logout()" class="btn btn-danger w-100 btn-sm bg-opacity-75 border-0"><i class="fas fa-sign-out-alt ms-1"></i> خروج</button>
            </div>
        </aside>

        <main class="main-content">
            <div class="top-navbar no-print">
                <div class="page-title"><h4 id="pageTitle">لوحة القيادة</h4></div>
                <div class="user-profile">
                    <div class="text-end d-none d-md-block">
                        <span class="d-block fw-bold text-dark" id="currentDate"></span>
                        <small class="text-muted">نظام إدارة التحصيلي</small>
                    </div>
                </div>
            </div>

            <!-- Sections -->
            <div id="section-dashboard" class="app-section">
                <div class="row g-4 mb-4">
                    <div class="col-md-3"><div class="stat-card blue h-100"><h3><span id="dashStudentCount">0</span></h3><p class="mb-0">عدد الطلاب</p><i class="fas fa-user-graduate stat-icon"></i></div></div>
                    <div class="col-md-3"><div class="stat-card green h-100"><h3><span id="dashTeacherCount">0</span></h3><p class="mb-0">المعلمين</p><i class="fas fa-chalkboard-teacher stat-icon"></i></div></div>
                    <div class="col-md-3"><div class="stat-card orange h-100"><h3><span id="dashMockCount">0</span></h3><p class="mb-0">الاختبارات</p><i class="fas fa-file-alt stat-icon"></i></div></div>
                    <div class="col-md-3"><div class="stat-card purple h-100"><h3><span id="dashAvg">0%</span></h3><p class="mb-0">الأداء العام</p><i class="fas fa-chart-line stat-icon"></i></div></div>
                </div>
                <div class="card"><div class="card-header-custom"><h5><i class="fas fa-chart-area ms-2"></i>تحليل الأداء الأسبوعي</h5></div><div class="card-body"><canvas id="mainTrendChart" style="max-height: 350px;"></canvas></div></div>
            </div>

            <!-- NEW: Grades Report Section -->
            <div id="section-grades-report" class="app-section hidden">
                <div class="card border-top border-5 border-success">
                    <div class="card-header-custom">
                        <h5><i class="fas fa-scroll ms-2"></i> تقرير الدرجات الشامل</h5>
                        <div class="no-print d-flex gap-2 ms-auto">
                            <button onclick="window.print()" class="btn btn-sm btn-dark"><i class="fas fa-print"></i> طباعة</button>
                            <button onclick="window.bulkSendGrades('parent')" class="btn btn-sm btn-success fw-bold"><i class="fab fa-whatsapp"></i> كل الأولياء</button>
                            <button onclick="window.bulkSendGrades('student')" class="btn btn-sm btn-outline-success fw-bold"><i class="fab fa-whatsapp"></i> كل الطلاب</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row g-3 no-print align-items-end">
                            <div class="col-md-2"><label class="small text-muted">الصف</label><select id="grLevel" class="form-select" onchange="window.updateGradesReportOptions()"><option value="all">الكل</option></select></div>
                            <div class="col-md-2"><label class="small text-muted">الفصل</label><select id="grClass" class="form-select" onchange="window.updateGradesReportOptions()"><option value="all">الكل</option></select></div>
                            <div class="col-md-2"><label class="small text-muted">النوع</label>
                                <select id="grType" class="form-select" onchange="window.updateGradesReportOptions()">
                                    <option value="both">واجبات واختبار محاكي</option>
                                    <option value="hw">واجبات فقط</option>
                                    <option value="mock">اختبار محاكي فقط</option>
                                </select>
                            </div>
                            <div class="col-md-2"><label class="small text-muted">الأسبوع</label><select id="grWeek" class="form-select" onchange="window.updateGradesReportOptions()"><option value="all">الجميع</option></select></div>
                            <div class="col-md-2"><label class="small text-muted">المحدد (رقم)</label><select id="grItem" class="form-select"><option value="all">الجميع</option></select></div>
                            <div class="col-md-2"><button onclick="window.renderGradesReport()" class="btn btn-primary w-100">عرض التقرير</button></div>
                        </div>
                        <hr class="no-print">
                        <div class="table-responsive mt-3">
                            <table class="table table-bordered table-hover text-center align-middle" id="gradesReportTable">
                                <thead class="table-light"></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- MODIFIED: Mock Exams Section -->
            <div id="section-mocks" class="app-section hidden">
                <div class="card border-top border-5 border-warning">
                    <div class="card-header-custom">
                        <h5><i class="fas fa-clipboard-check ms-2"></i> سجل ودرجات الاختبارات المحاكية</h5>
                        <div class="no-print d-flex gap-2">
                            <button onclick="window.bulkSendMocks('parent')" class="btn btn-sm btn-success fw-bold"><i class="fab fa-whatsapp"></i> كل الأولياء</button>
                            <button onclick="window.bulkSendMocks('student')" class="btn btn-sm btn-outline-success fw-bold"><i class="fab fa-whatsapp"></i> كل الطلاب</button>
                            <button onclick="window.addMockExam()" class="btn btn-warning btn-sm">جدولة اختبار جديد</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Filters -->
                        <div class="row g-3 align-items-end no-print">
                             <div class="col-md-2">
                                 <label class="small text-muted">الصف</label>
                                 <select id="mockRepLevel" class="form-select" onchange="window.renderMockGradesReport()">
                                     <option value="all">الكل</option>
                                 </select>
                             </div>
                             <div class="col-md-2">
                                 <label class="small text-muted">الفصل</label>
                                 <select id="mockRepClass" class="form-select" onchange="window.renderMockGradesReport()">
                                     <option value="all">الكل</option>
                                 </select>
                             </div>
                             <div class="col-md-2">
                                 <label class="small text-muted">النوع</label>
                                 <input type="text" class="form-control" value="اختبار محاكي" readonly disabled>
                             </div>
                             <div class="col-md-2">
                                 <label class="small text-muted">الأسبوع</label>
                                 <select id="mockRepWeek" class="form-select" onchange="window.updateMockItemOptions()"></select>
                             </div>
                             <div class="col-md-2">
                                 <label class="small text-muted">المحدد</label>
                                 <select id="mockRepItem" class="form-select">
                                     <option value="all">جميع الاختبارات المحاكية</option>
                                 </select>
                             </div>
                             <div class="col-md-2">
                                 <button onclick="window.renderMockGradesReport()" class="btn btn-primary w-100">عرض النتائج</button>
                             </div>
                        </div>
                        
                        <div class="table-responsive mt-3">
                            <table class="table table-bordered table-hover text-center align-middle" id="mockReportTable">
                                <thead class="table-light"></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <div class="card mt-4">
                    <div class="card-header-custom py-2"><h6 class="m-0 text-muted">جدول الاختبارات المجدولة</h6></div>
                    <table class="table table-hover mb-0" id="mocksTable"><thead><tr><th>الاختبار</th><th>التاريخ</th><th>المادة</th><th>الصف</th><th>خيارات</th></tr></thead><tbody></tbody></table>
                </div>
            </div>

            <div id="section-absentees" class="app-section hidden">
                <div class="card">
                    <div class="card-header-custom">
                        <h5><i class="fas fa-user-times ms-2"></i> تقرير الغائبين</h5>
                        <div class="no-print d-flex gap-2">
                            <button onclick="window.bulkSendAbsentees('parent')" class="btn btn-sm btn-success fw-bold"><i class="fab fa-whatsapp"></i> كل الأولياء</button>
                            <button onclick="window.bulkSendAbsentees('student')" class="btn btn-sm btn-outline-success fw-bold"><i class="fab fa-whatsapp"></i> كل الطلاب</button>
                            <button onclick="window.exportTableToExcel('absTable', 'Absentees_Report')" class="btn btn-sm btn-success"><i class="fas fa-file-excel"></i> اكسيل</button>
                            <button onclick="window.print()" class="btn btn-sm btn-dark"><i class="fas fa-print"></i> طباعة</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row g-3 mb-3 no-print">
                            <div class="col-md-2"><label>الصف</label><select id="absLevel" class="form-select" onchange="window.renderAbsentees()"><option value="all">الكل</option></select></div>
                            <div class="col-md-2"><label>الفصل</label><select id="absClass" class="form-select" onchange="window.renderAbsentees()"><option value="all">الكل</option></select></div>
                            <div class="col-md-2"><label>الأسبوع</label><select id="absWeek" class="form-select" onchange="window.updateAbsOptions()"></select></div>
                            <div class="col-md-2"><label>نوع البند</label><select id="absType" class="form-select" onchange="window.updateAbsOptions()"><option value="hw">واجبات</option><option value="mock">اختبار محاكي</option></select></div>
                            <div class="col-md-2"><label>المحدد</label><select id="absItem" class="form-select"></select></div>
                            <div class="col-md-2"><button class="btn btn-primary w-100 mt-4" onclick="window.renderAbsentees()">عرض</button></div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-bordered table-striped text-center align-middle" id="absTable">
                                <thead></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div id="section-notifications" class="app-section hidden">
                 <div class="card p-3">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="text-primary m-0"><i class="fas fa-bell ms-2"></i> الإشعارات والملفات</h5>
                        <div class="no-print">
                            <button onclick="window.exportTableToExcel('allNotifsTable', 'Notifications_Report')" class="btn btn-sm btn-success"><i class="fas fa-file-excel"></i> اكسيل</button>
                            <button onclick="window.print()" class="btn btn-sm btn-dark"><i class="fas fa-print"></i> طباعة</button>
                        </div>
                    </div>
                    <ul class="nav nav-pills mb-4 custom-tabs" role="tablist">
                        <li class="nav-item"><button class="nav-link active" data-bs-target="#notif-summary" data-bs-toggle="tab">إجمالي الإشعارات</button></li>
                        <li class="nav-item"><button class="nav-link" data-bs-target="#notif-profile" data-bs-toggle="tab">ملف الطلاب</button></li>
                    </ul>
                    <div class="tab-content">
                        <div class="tab-pane fade show active" id="notif-summary">
                            <div class="row g-3 mb-3 no-print">
                                <div class="col-md-3"><label>الصف</label><select id="notifLevel" class="form-select" onchange="window.renderNotificationsSummary()"><option value="all">الكل</option></select></div>
                                <div class="col-md-3"><label>الفصل</label><select id="notifClass" class="form-select" onchange="window.renderNotificationsSummary()"><option value="all">الكل</option></select></div>
                                <div class="col-md-3"><label>بحث (اسم الطالب)</label><input type="text" id="notifSearch" class="form-control" oninput="window.renderNotificationsSummary()" placeholder="..."></div>
                                <div class="col-md-3 d-flex align-items-end"><div class="alert alert-info w-100 py-2 m-0 text-center">الإجمالي: <span id="totalNotifs" class="fw-bold">0</span></div></div>
                            </div>
                            <table class="table table-hover table-bordered" id="allNotifsTable">
                                <thead class="table-light"><tr><th>التاريخ</th><th>الطالب</th><th>الصف</th><th>الفصل</th><th>نوع الإشعار</th><th>السبب</th><th>الرد</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                        <div class="tab-pane fade" id="notif-profile">
                             <div class="row g-3 mb-3 no-print">
                                <div class="col-md-4"><input type="text" id="notifSearchStudent" class="form-control" placeholder="بحث عن اسم الطالب..." oninput="window.searchStudentForProfile()"></div>
                                <div class="col-md-8"><select id="notifStudentSelect" class="form-select" onchange="window.renderStudentProfile()"><option value="">اختر الطالب</option></select></div>
                             </div>
                             <div id="studentProfileContainer" class="d-none">
                                 <div class="card bg-light p-3 mb-3">
                                     <h5 class="text-primary mb-2" id="profName"></h5>
                                     <div class="d-flex gap-4 small text-muted">
                                         <span id="profLevel"></span>
                                         <span id="profClass"></span>
                                     </div>
                                 </div>
                                 <h6 class="border-bottom pb-2">سجل الإشعارات والتواصل</h6>
                                 <table class="table table-sm" id="studentNotifTable">
                                     <thead><tr><th>التاريخ</th><th>النوع</th><th>نص الإشعار / السبب</th><th>الرد</th></tr></thead>
                                     <tbody></tbody>
                                 </table>
                             </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="section-communication" class="app-section hidden">
                <div class="card">
                    <div class="card-header-custom"><h5><i class="fas fa-headset ms-2"></i> سجل التواصل</h5></div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-3"><label>التاريخ</label><input type="date" id="commDate" class="form-control"></div>
                            <div class="col-md-3"><label>الصف</label><select id="commLevel" class="form-select" onchange="window.updateCommStudents()"></select></div>
                            <div class="col-md-3"><label>الفصل</label><select id="commClass" class="form-select" onchange="window.updateCommStudents()"></select></div>
                            <div class="col-md-3"><label>الطالب</label><select id="commStudent" class="form-select"></select></div>
                            
                            <div class="col-md-4"><label>الإجراء</label>
                                <select id="commAction" class="form-select">
                                    <option value="رسالة sms">رسالة sms</option>
                                    <option value="استدعاء">استدعاء</option>
                                    <option value="مكالمة هاتفية">مكالمة هاتفية</option>
                                    <option value="واتساب">واتساب</option>
                                </select>
                            </div>
                            <div class="col-md-8"><label>السبب</label><input type="text" id="commReason" class="form-control" placeholder="سبب التواصل"></div>
                            <div class="col-md-12"><label>رد ولي الأمر</label><textarea id="commReply" class="form-control" rows="2" placeholder="ملاحظات أو رد ولي الأمر"></textarea></div>
                            <div class="col-md-12 text-end"><button onclick="window.saveCommunication()" class="btn btn-success px-5"><i class="fas fa-save ms-2"></i> حفظ السجل</button></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="section-comparisons" class="app-section hidden">
                <div class="card border-top border-5 border-info">
                    <div class="card-header-custom">
                        <h5><i class="fas fa-balance-scale ms-2"></i> مقارنة النتائج التفصيلية</h5>
                        <button onclick="window.print()" class="btn btn-sm btn-dark no-print"><i class="fas fa-print"></i> طباعة</button>
                    </div>
                    <div class="card-body bg-light">
                        <div class="row g-3 align-items-end no-print">
                            <div class="col-md-3">
                                <label class="small text-muted mb-1">الصف الدراسي</label>
                                <select id="cmpLevel" class="form-select" onchange="window.toggleComparisonInputs()">
                                    <option value="">اختر الصف</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="small text-muted mb-1">الفصل</label>
                                <select id="cmpClass" class="form-select" onchange="window.toggleComparisonInputs()">
                                    <option value="">الكل / اختر الفصل</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="small text-muted mb-1">نوع المقارنة</label>
                                <select id="cmpMode" class="form-select" onchange="window.toggleComparisonInputs()">
                                    <option value="subjects">مقارنة بين المواد</option>
                                    <option value="teachers">مقارنة بين المعلمين</option>
                                    <option value="classes">مقارنة بين الفصول (في مادة)</option>
                                </select>
                            </div>
                            <div class="col-md-3" id="cmpSubjectDiv" style="display:none;">
                                <label class="small text-muted mb-1">المادة (للمقارنة بين الفصول)</label>
                                <select id="cmpSubject" class="form-select">
                                    <option value="">اختر المادة</option>
                                </select>
                            </div>
                            <div class="col-md-12 mt-3">
                                <button onclick="window.drawComparisonChart()" class="btn btn-primary w-100">
                                    <i class="fas fa-search me-2"></i> عرض المقارنة
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-body">
                        <div class="full-chart-container">
                            <canvas id="detailedComparisonChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div id="section-structure" class="app-section hidden">
                <div class="card p-3">
                    <ul class="nav nav-pills mb-4 custom-tabs" role="tablist">
                        <li class="nav-item"><button class="nav-link active" data-bs-target="#tab-subjects" data-bs-toggle="tab"><i class="fas fa-book ms-2"></i>المواد الدراسية</button></li>
                        <li class="nav-item"><button class="nav-link" data-bs-target="#tab-levels" data-bs-toggle="tab"><i class="fas fa-layer-group ms-2"></i>الصفوف</button></li>
                        <li class="nav-item"><button class="nav-link" data-bs-target="#tab-classes" data-bs-toggle="tab"><i class="fas fa-door-open ms-2"></i>الفصول</button></li>
                        <li class="nav-item"><button class="nav-link" data-bs-target="#tab-weeks" data-bs-toggle="tab"><i class="fas fa-calendar-week ms-2"></i>الأسابيع</button></li>
                    </ul>
                    <div class="tab-content">
                        <div class="tab-pane fade show active" id="tab-subjects">
                            <div class="row g-3 align-items-center mb-4"><div class="col-auto"><input type="text" id="newSubjectName" class="form-control" placeholder="اسم المادة"></div><div class="col-auto"><button class="btn btn-primary" onclick="window.addStruct('subjects')">إضافة</button></div></div>
                            <ul id="list-subjects" class="list-group w-50"></ul>
                        </div>
                        <div class="tab-pane fade" id="tab-levels">
                            <div class="row g-3 align-items-center mb-4"><div class="col-auto"><input type="text" id="newLevelName" class="form-control" placeholder="اسم الصف"></div><div class="col-auto"><button class="btn btn-primary" onclick="window.addStruct('levels')">إضافة</button></div></div>
                            <ul id="list-levels" class="list-group w-50"></ul>
                        </div>
                        <div class="tab-pane fade" id="tab-classes">
                            <div class="row g-3 align-items-center mb-4"><div class="col-auto"><input type="text" id="newClassName" class="form-control" placeholder="اسم الفصل"></div><div class="col-auto"><button class="btn btn-primary" onclick="window.addStruct('classes')">إضافة</button></div></div>
                            <ul id="list-classes" class="list-group w-50"></ul>
                        </div>
                        <div class="tab-pane fade" id="tab-weeks">
                            <div class="card bg-light p-3 mb-4 border-0">
                                <div class="row g-2">
                                    <div class="col-md-5"><input type="text" id="newWeekName" class="form-control" placeholder="اسم الأسبوع"></div>
                                    <div class="col-md-3"><input type="number" id="newWeekHW" class="form-control" placeholder="عدد الواجبات"></div>
                                    <div class="col-md-2"><button class="btn btn-primary w-100" onclick="window.addWeekStruct()">حفظ</button></div>
                                </div>
                            </div>
                            <table class="table"><tbody id="list-weeks"></tbody></table>
                        </div>
                    </div>
                </div>
            </div>

            <div id="section-users" class="app-section hidden">
                <div class="card mb-4">
                    <div class="card-header-custom"><h5>إضافة مستخدم</h5></div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-3"><label>المستخدم</label><input type="text" id="uUsername" class="form-control"></div>
                            <div class="col-md-3"><label>الاسم الكامل</label><input type="text" id="uFullName" class="form-control"></div>
                            <div class="col-md-3"><label>رقم الجوال</label><input type="text" id="uPhone" class="form-control" placeholder="9665xxxxxxxx"></div>
                            <div class="col-md-3"><label>الصلاحية</label>
                                <select id="uRole" class="form-select" onchange="window.toggleTeacherFields()">
                                    <option value="teacher">معلم</option>
                                    <option value="counselor">موجه طلابي</option>
                                    <option value="agent">وكيل شؤون معلمين</option>
                                    <option value="manager">مدير</option>
                                    <option value="admin">مشرف نظام (Admin)</option>
                                </select>
                            </div>
                        </div>
                        <div id="teacherFields" class="mt-3 p-3 border rounded bg-light">
                            <div class="row g-3">
                                <div class="col-md-4"><label>المادة</label><select id="uSubject" class="form-select"></select></div>
                                <div class="col-md-8"><label>الفصول (Ctrl للتعدد)</label><select id="uClasses" class="form-select" multiple size="3"></select></div>
                            </div>
                        </div>
                        <button onclick="window.createNewUser()" class="btn btn-success mt-3">حفظ</button>
                    </div>
                </div>
                <div class="card"><div class="card-body p-0"><table class="table table-hover mb-0 align-middle"><thead class="table-light"><tr><th>الاسم</th><th>اسم المستخدم</th><th>الجوال</th><th>الدور</th><th>كلمة المرور</th><th>خيارات</th></tr></thead><tbody id="usersTableBody"></tbody></table></div></div>
            </div>

            <div id="section-students" class="app-section hidden">
                <div class="card">
                    <div class="card-header-custom">
                        <h5>سجل الطلاب</h5>
                        <div class="no-print">
                            <button onclick="window.downloadTemplate()" class="btn btn-outline-primary btn-sm ms-2"><i class="fas fa-download"></i> تحميل القالب</button>
                            
                            <button onclick="document.getElementById('excelImport').click()" class="btn btn-outline-success btn-sm"><i class="fas fa-file-excel"></i> استيراد</button>
                            <input type="file" id="excelImport" class="d-none" accept=".xlsx, .xls">
                            
                            <button onclick="window.addStudentModal()" class="btn btn-primary btn-sm"><i class="fas fa-plus"></i> إضافة طالب</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row g-3 mb-3 no-print">
                            <div class="col-md-3"><select id="filterLevel" class="form-select" onchange="window.renderStudents()"><option value="">تصفية حسب الصف</option></select></div>
                            <div class="col-md-3"><select id="filterClass" class="form-select" onchange="window.renderStudents()"><option value="">تصفية حسب الفصل</option></select></div>
                        </div>
                        <table class="table table-striped" id="studentsTable">
                            <thead><tr><th>الاسم</th><th>الصف</th><th>الفصل</th><th>جوال الطالب</th><th>جوال الولي</th><th>خيارات</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="section-grading" class="app-section hidden">
                <div class="card mb-4 border-top border-primary border-4">
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-3"><label class="text-muted small">الفصل</label><select id="gradingClass" class="form-select" onchange="window.loadGradingSheet()"></select></div>
                            <div class="col-md-3"><label class="text-muted small">الأسبوع</label><select id="gradingWeek" class="form-select" onchange="window.loadGradingSheet()"></select></div>
                            <div class="col-md-3 ms-auto"><button onclick="window.saveGrades()" class="btn btn-primary w-100 mt-4"><i class="fas fa-save"></i> حفظ الدرجات</button></div>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-bordered text-center mb-0 align-middle" id="gradingTable">
                                <thead class="table-light text-primary" id="gradingHeader"></thead>
                                <tbody id="gradingBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div id="section-assign-reports" class="app-section hidden">
                
                <div class="card p-3 mb-4 no-print border-start border-5 border-warning">
                    <h5 class="mb-3 text-primary"><i class="fas fa-chart-pie me-2"></i> مركز التقارير الموحد</h5>
                    
                    <ul class="nav nav-tabs custom-tabs mb-3" id="reportsTabs">
                        <li class="nav-item"><button class="nav-link active" data-bs-target="#rep-general" data-bs-toggle="tab">التحليل العام</button></li>
                        <li class="nav-item"><button class="nav-link" data-bs-target="#rep-homework" data-bs-toggle="tab">تقارير الواجبات</button></li>
                        <li class="nav-item"><button class="nav-link" data-bs-target="#rep-status" data-bs-toggle="tab">حالة الرصد (إدارة)</button></li>
                        <li class="nav-item"><button class="nav-link" data-bs-target="#rep-export" data-bs-toggle="tab">تصدير النتائج</button></li>
                    </ul>

                    <div class="tab-content p-2">
                        <div class="tab-pane fade show active" id="rep-general">
                            <div class="row g-3 align-items-end">
                                <div class="col-md-2"><label class="small text-muted">الصف</label><select id="arLevel" class="form-select"><option value="all">الكل</option></select></div>
                                <div class="col-md-2"><label class="small text-muted">الفصل</label><select id="arClass" class="form-select"><option value="all">الكل</option></select></div>
                                <div class="col-md-2"><label class="small text-muted">الأسبوع</label><select id="arWeek" class="form-select"></select></div>
                                <div class="col-md-2"><label class="small text-muted">المادة (للتفصيلي)</label><select id="arSubject" class="form-select"></select></div>
                                <div class="col-md-4 d-flex gap-2">
                                    <button onclick="window.renderWeeklyGeneralReport()" class="btn btn-primary flex-fill"><i class="fas fa-chart-bar"></i> تحليل عام</button>
                                    <button onclick="window.renderDetailedSubjectReport()" class="btn btn-secondary flex-fill"><i class="fas fa-list-alt"></i> تقرير المادة</button>
                                </div>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="rep-homework">
                            <div class="row g-3 align-items-end">
                                <div class="col-md-2"><label class="small text-muted">الصف</label><select id="hwRepLevel" class="form-select"><option value="all">الكل</option></select></div>
                                <div class="col-md-2"><label class="small text-muted">الفصل</label><select id="hwRepClass" class="form-select"><option value="all">الكل</option></select></div>
                                <div class="col-md-2"><label class="small text-muted">النوع</label>
                                    <select id="hwRepType" class="form-select" onchange="window.updateHwOptions()">
                                        <option value="hw">واجبات</option>
                                        <option value="mock">اختبار محاكي</option>
                                    </select>
                                </div>
                                <div class="col-md-2"><label class="small text-muted">المحدد</label><select id="hwRepItem" class="form-select"><option value="all">الجميع</option></select></div>
                                <div class="col-md-2"><label class="small text-muted">الأسبوع</label><select id="hwRepWeek" class="form-select"></select></div>
                                <div class="col-md-2">
                                    <button onclick="window.renderHomeworkReport()" class="btn btn-success w-100">عرض التقرير</button>
                                    <div class="d-flex gap-1 mt-2">
                                        <button onclick="window.bulkSendHomework('parent')" class="btn btn-sm btn-success flex-fill fw-bold"><i class="fab fa-whatsapp"></i> أولياء</button>
                                        <button onclick="window.bulkSendHomework('student')" class="btn btn-sm btn-outline-success flex-fill fw-bold"><i class="fab fa-whatsapp"></i> طلاب</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="rep-status">
                            <div class="row g-3 align-items-end">
                                <div class="col-md-2"><label class="small text-muted">النوع</label><select id="stRepType" class="form-select"><option value="both">واجبات واختبارات</option></select></div>
                                <div class="col-md-2"><label class="small text-muted">الصف</label><select id="stRepLevel" class="form-select"><option value="all">الجميع</option></select></div>
                                <div class="col-md-2"><label class="small text-muted">الفصل</label><select id="stRepClass" class="form-select"><option value="all">الجميع</option></select></div>
                                <div class="col-md-2"><label class="small text-muted">المادة</label><select id="stRepSubject" class="form-select"><option value="all">الجميع</option></select></div>
                                <div class="col-md-2"><label class="small text-muted">الأسبوع</label><select id="stRepWeek" class="form-select"></select></div>
                                <div class="col-md-2">
                                    <button onclick="window.renderGradingStatusReport()" class="btn btn-info text-white w-100 mb-2"><i class="fas fa-check-circle"></i> عرض الحالة</button>
                                    <button onclick="window.bulkNotifyTeachers()" class="btn btn-warning w-100"><i class="fab fa-whatsapp"></i> إشعار جميع المعلمين</button>
                                </div>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="rep-export">
                            <div class="row g-3 align-items-end">
                                <div class="col-md-2"><label class="small text-muted">الصف</label><select id="expLevel" class="form-select"><option value="all">الجميع</option></select></div>
                                <div class="col-md-2"><label class="small text-muted">الفصل</label><select id="expClass" class="form-select"><option value="all">الجميع</option></select></div>
                                <div class="col-md-2"><label class="small text-muted">المادة</label><select id="expSubject" class="form-select"><option value="all">الجميع</option></select></div>
                                <div class="col-md-3"><label class="small text-muted">الأسبوع</label><select id="expWeek" class="form-select"><option value="all">الجميع (تراكمي)</option></select></div>
                                <div class="col-md-3 d-flex gap-2">
                                    <button onclick="window.renderExportPreview()" class="btn btn-dark flex-fill"><i class="fas fa-eye"></i> معاينة</button>
                                    <button onclick="window.exportTableToExcel('assignReportTable', 'Results')" class="btn btn-success flex-fill"><i class="fas fa-file-excel"></i> Excel</button>
                                    <button onclick="window.print()" class="btn btn-danger flex-fill"><i class="fas fa-file-pdf"></i> PDF</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="statsDashboard" class="row mb-4 hidden no-print">
                    <div class="col-md-4">
                        <div class="card h-100">
                            <div class="card-header-custom py-2"><h6 class="m-0 text-muted">نسبة الإنجاز</h6></div>
                            <div class="card-body d-flex justify-content-center align-items-center">
                                <div class="report-chart-container"><canvas id="repPieChart"></canvas></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card h-100">
                            <div class="card-header-custom py-2"><h6 class="m-0 text-muted">توزيع التقديرات</h6></div>
                            <div class="card-body d-flex justify-content-center align-items-center">
                                <div class="report-chart-container"><canvas id="repBarChart"></canvas></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="row g-3">
                            <div class="col-12"><div class="card bg-primary text-white p-3 mb-0"><h2 class="display-6 fw-bold mb-0" id="statAvg">0%</h2><small>متوسط الأداء العام</small></div></div>
                            <div class="col-6"><div class="card bg-success text-white p-3 mb-0"><h4 class="fw-bold mb-0" id="statHigh">0</h4><small>أعلى درجة</small></div></div>
                            <div class="col-6"><div class="card bg-danger text-white p-3 mb-0"><h4 class="fw-bold mb-0" id="statLow">0</h4><small>أقل درجة</small></div></div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header-custom">
                        <h5 id="reportTitle">نتائج التقرير</h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-bordered table-striped text-center align-middle mb-0" id="assignReportTable">
                                <thead class="table-light"></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div id="section-mocks" class="app-section hidden">
                <div class="card border-top border-5 border-warning">
                    <div class="card-header-custom">
                        <h5><i class="fas fa-clipboard-check ms-2"></i> سجل ودرجات الاختبارات المحاكية</h5>
                        <div class="no-print d-flex gap-2">
                            <button onclick="window.bulkSendMocks('parent')" class="btn btn-sm btn-success fw-bold"><i class="fab fa-whatsapp"></i> كل الأولياء</button>
                            <button onclick="window.bulkSendMocks('student')" class="btn btn-sm btn-outline-success fw-bold"><i class="fab fa-whatsapp"></i> كل الطلاب</button>
                            <button onclick="window.addMockExam()" class="btn btn-warning btn-sm">جدولة اختبار جديد</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Filters -->
                        <div class="row g-3 align-items-end no-print">
                             <div class="col-md-2">
                                 <label class="small text-muted">الصف</label>
                                 <select id="mockRepLevel" class="form-select" onchange="window.renderMockGradesReport()">
                                     <option value="all">الكل</option>
                                 </select>
                             </div>
                             <div class="col-md-2">
                                 <label class="small text-muted">الفصل</label>
                                 <select id="mockRepClass" class="form-select" onchange="window.renderMockGradesReport()">
                                     <option value="all">الكل</option>
                                 </select>
                             </div>
                             <div class="col-md-2">
                                 <label class="small text-muted">النوع</label>
                                 <input type="text" class="form-control" value="اختبار محاكي" readonly disabled>
                             </div>
                             <div class="col-md-2">
                                 <label class="small text-muted">الأسبوع</label>
                                 <select id="mockRepWeek" class="form-select" onchange="window.updateMockItemOptions()"></select>
                             </div>
                             <div class="col-md-2">
                                 <label class="small text-muted">المحدد</label>
                                 <select id="mockRepItem" class="form-select">
                                     <option value="all">جميع الاختبارات المحاكية</option>
                                 </select>
                             </div>
                             <div class="col-md-2">
                                 <button onclick="window.renderMockGradesReport()" class="btn btn-primary w-100">عرض النتائج</button>
                             </div>
                        </div>
                        
                        <div class="table-responsive mt-3">
                            <table class="table table-bordered table-hover text-center align-middle" id="mockReportTable">
                                <thead class="table-light"></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <div class="card mt-4">
                    <div class="card-header-custom py-2"><h6 class="m-0 text-muted">جدول الاختبارات المجدولة</h6></div>
                    <table class="table table-hover mb-0" id="mocksTable"><thead><tr><th>الاختبار</th><th>التاريخ</th><th>المادة</th><th>الصف</th><th>خيارات</th></tr></thead><tbody></tbody></table>
                </div>
            </div>

        </main>
    </div>

    <!-- Modals -->
    <div class="modal fade" id="missingGradesModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">تفاصيل الرصد الناقص</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="table-responsive">
                        <table class="table table-bordered table-sm text-center align-middle" id="missingGradesTable">
                            <thead class="table-light"></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editUserModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">تعديل بيانات المستخدم</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <input type="hidden" id="edit_uid">
                    <div class="mb-3"><label class="form-label">الاسم الكامل</label><input type="text" id="edit_name" class="form-control"></div>
                    <div class="mb-3"><label class="form-label">رقم الجوال</label><input type="text" id="edit_phone" class="form-control"></div>
                    <div class="mb-3"><label class="form-label">كلمة المرور الجديدة</label><input type="text" id="edit_pass" class="form-control" placeholder="أدخل كلمة مرور جديدة للتغيير"></div>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button><button type="button" class="btn btn-primary" onclick="window.saveUserEdit()">حفظ التغييرات</button></div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="profileModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">تغيير كلمة المرور</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <div class="mb-3"><label class="form-label">كلمة المرور الجديدة</label><input type="text" id="my_new_pass" class="form-control" placeholder="اكتب كلمة المرور الجديدة"></div>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button><button type="button" class="btn btn-success" onclick="window.saveMyPassword()">حفظ التحديث</button></div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="mockExamModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">جدولة اختبار محاكي</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <div class="mb-3"><label class="form-label">اسم الاختبار</label><input type="text" id="mockName" class="form-control" placeholder="مثال: الاختبار الأول"></div>
                    <div class="mb-3"><label class="form-label">تاريخ الاختبار</label><input type="date" id="mockDate" class="form-control"></div>
                    <div class="mb-3"><label class="form-label">المادة</label><select id="mockSubject" class="form-select"></select></div>
                    <div class="mb-3"><label class="form-label">الصف</label><select id="mockLevel" class="form-select"></select></div>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button><button type="button" class="btn btn-primary" onclick="window.saveMockExam()">حفظ الجدول</button></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
          apiKey: "AIzaSyCEnT38XrTlck2eR84xzQEBE0oXb5hRTvI",
          authDomain: "saat-f940b.firebaseapp.com",
          databaseURL:  "https://saat-f940b-default-rtdb.firebaseio.com/",
          projectId: "saat-f940b",
          storageBucket: "saat-f940b.firebasestorage.app",
          messagingSenderId: "1000735214982",
          appId: "1:1000735214982:web:31d5831685b8c98fb9b007"
        };


        let app, db, dbRef;
        let isFirebaseActive = false;
        let missingModalBS = null;

        try {
            app = initializeApp(firebaseConfig);
            db = getDatabase(app);
            dbRef = ref(db);
            isFirebaseActive = true;
        } catch (e) {
            console.warn("Firebase Init Failed, working offline.");
        }

        // --- Utils: Toast Notifications ---
        window.showToast = function(msg, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast-msg ${type}`;
            const icon = type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle';
            toast.innerHTML = `<i class="fas fa-${icon}"></i> <span>${msg}</span>`;
            container.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Security Measures
        document.addEventListener('contextmenu', (e) => e.preventDefault());
        document.onkeydown = function(e) {
            if(e.keyCode == 123) return false; // F12
            if(e.ctrlKey && e.shiftKey && e.keyCode == 'I'.charCodeAt(0)) return false;
            if(e.ctrlKey && e.shiftKey && e.keyCode == 'C'.charCodeAt(0)) return false;
            if(e.ctrlKey && e.shiftKey && e.keyCode == 'J'.charCodeAt(0)) return false;
            if(e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) return false;
        }

        let DB = { users: [], subjects: ['لغة عربية', 'رياضيات', 'فيزياء', 'أحياء'], levels: ['الأول الثانوي', 'الثاني الثانوي'], classes: ['101', '102', '201'], weeks: [{name: 'الأسبوع الأول', hw: 3}, {name: 'الأسبوع الثاني', hw: 2}], students: [], grades: [], mocks: [], communications: [], currentUser: null };

        let reportCharts = { pie: null, bar: null };
        let comparisonCharts = { sub: null, teach: null, detailed: null };
        let editModalBS = null;
        let profileModalBS = null;
        let mockModalBS = null;

        async function loadFromFirebase() {
            const btn = document.getElementById('loginBtn');
            const loader = document.getElementById('dbLoader');
            btn.disabled = true; loader.style.display = 'block';

            if (!isFirebaseActive) { finalizeLoad(); return; }

            try {
                const timeoutPromise = new Promise((_, reject) => setTimeout(() => reject(new Error("Timeout")), 3000));
                const dataPromise = get(child(dbRef, 'schoolSystem'));
                const snapshot = await Promise.race([dataPromise, timeoutPromise]);
                if (snapshot.exists()) {
                    DB = snapshot.val();
                    DB.currentUser = null;
                    if(!DB.communications) DB.communications = [];
                    console.log("Data loaded");
                } else {
                    // Initial Save if empty
                    saveData('', DB); 
                }
            } catch (error) {
                console.warn("Connection/Load Error, using Local Defaults");
            } finally {
                finalizeLoad();
            }
        }
        
        function finalizeLoad() {
            const btn = document.getElementById('loginBtn');
            const loader = document.getElementById('dbLoader');
            btn.disabled = false; btn.innerText = "تسجيل الدخول"; loader.style.display = 'none';

            // Check for saved session
            const saved = localStorage.getItem('schoolUser');
            if(saved) {
                try {
                    const u = JSON.parse(saved);
                    if(u.username === 'Mahmoud') {
                        DB.currentUser = u;
                        launchSystem();
                    } else if(DB.users) {
                        const exists = DB.users.find(x => x.username === u.username && x.password === u.password && x.active !== false);
                        if(exists) {
                            DB.currentUser = exists;
                            launchSystem();
                        }
                    }
                } catch(e) { localStorage.removeItem('schoolUser'); }
            }
        }

        loadFromFirebase();

        async function saveData(path, data) {
            if (!isFirebaseActive) return;
            window.showToast('جاري الحفظ في السيرفر...', 'info');
            try {
                const targetRef = path ? ref(db, 'schoolSystem/' + path) : ref(db, 'schoolSystem');
                await set(targetRef, data);
                window.showToast('تم الحفظ بنجاح', 'success');
            } catch (error) {
                console.error("Save failed:", error);
                window.showToast('فشل الحفظ: تأكد من الاتصال', 'error');
            }
        }

        window.login = function() {
            const u = document.getElementById('username').value.trim();
            const p = document.getElementById('password').value.trim();
            if(u==='Mahmoud' && p==='Ma@521990') {
                DB.currentUser = { fullName:'المشرف العام', role:'admin', username:'Mahmoud' };
                localStorage.setItem('schoolUser', JSON.stringify(DB.currentUser));
                launchSystem(); return;
            }
            if(!DB.users) DB.users = [];
            const user = DB.users.find(usr => usr.username === u && usr.password === p && usr.active !== false);
            if(user) { 
                DB.currentUser = user; 
                localStorage.setItem('schoolUser', JSON.stringify(user));
                launchSystem(); 
            } else { alert('بيانات خطأ أو الحساب غير مفعل'); }
        }

        window.toggleLoginPassword = function() {
            const passwordInput = document.getElementById('password');
            const toggleIcon = document.getElementById('togglePasswordIcon');
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text'; toggleIcon.classList.remove('fa-eye'); toggleIcon.classList.add('fa-eye-slash');
            } else {
                passwordInput.type = 'password'; toggleIcon.classList.remove('fa-eye-slash'); toggleIcon.classList.add('fa-eye');
            }
        }

        window.logout = function() { 
            localStorage.removeItem('schoolUser'); 
            location.reload(); 
        }

        function launchSystem() {
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('mainSystem').classList.remove('hidden');
            document.getElementById('currentDate').innerText = new Date().toLocaleDateString('ar-SA', {weekday:'long', year:'numeric', month:'long', day:'numeric'});
            document.getElementById('userNameDisplay').innerText = DB.currentUser.fullName;
            document.getElementById('userRoleDisplay').innerText = getRoleAr(DB.currentUser.role);
            buildSidebar();
            populateDropdowns();
            const role = DB.currentUser.role;
            if(role === 'teacher') showSection('grading'); else showSection('dashboard');
            editModalBS = new bootstrap.Modal(document.getElementById('editUserModal'));
            profileModalBS = new bootstrap.Modal(document.getElementById('profileModal'));
            mockModalBS = new bootstrap.Modal(document.getElementById('mockExamModal'));
            missingModalBS = new bootstrap.Modal(document.getElementById('missingGradesModal'));
        }

        function getRoleAr(role) {
            const roles = {'admin':'مشرف النظام', 'teacher':'معلم', 'counselor':'موجه طلابي', 'manager':'مدير المدرسة', 'agent':'وكيل شؤون معلمين'};
            return roles[role] || role;
        }

        function buildSidebar() {
            const role = DB.currentUser.role;
            const menu = document.getElementById('sidebarMenu');
            let items = [];

            if(role !== 'teacher') items.push({id:'dashboard', icon:'fa-tachometer-alt', txt:'لوحة القيادة'});
            
            // Updated to include counselor
            if(['admin', 'agent', 'manager', 'counselor'].includes(role)) {
                items.push({id:'grades-report', icon:'fa-scroll', txt:'تقرير الدرجات الشامل'});
                items.push({id:'comparisons', icon:'fa-balance-scale', txt:'مقارنة النتائج'});
            }

            if(role === 'admin') {
                items.push({id:'structure', icon:'fa-layer-group', txt:'الهيكل الدراسي'});
                items.push({id:'users', icon:'fa-users-cog', txt:'المستخدمين'});
            }

            if(['admin', 'counselor'].includes(role)) {
                 items.push({id:'students', icon:'fa-user-graduate', txt:'تسكين الطلاب'});
            }

            if(['admin', 'counselor', 'agent', 'manager'].includes(role)) {
                items.push({id:'assign-reports', icon:'fa-chart-pie', txt:'التقارير والإحصائيات'});
                items.push({id:'mocks', icon:'fa-clipboard-check', txt:'الاختبارات المحاكية'});
                items.push({id:'absentees', icon:'fa-user-times', txt:'الغائبون'});
                items.push({id:'notifications', icon:'fa-bell', txt:'الإشعارات'});
                items.push({id:'communication', icon:'fa-headset', txt:'التواصل'});
            }

            if(role === 'teacher') {
                items.push({id:'grading', icon:'fa-pen-alt', txt:'رصد الدرجات'});
            }

            menu.innerHTML = items.map(i => 
                `<div class="nav-link" onclick="window.showSection('${i.id}', this)">
                    <i class="fas ${i.icon}"></i> <span>${i.txt}</span>
                </div>`
            ).join('');
            if(menu.firstElementChild) menu.firstElementChild.classList.add('active');
        }

        window.showSection = function(id, elem) {
            document.querySelectorAll('.app-section').forEach(d => d.classList.add('hidden'));
            
            const targetSec = document.getElementById(`section-${id}`);
            if (targetSec) {
                targetSec.classList.remove('hidden');
            } else {
                console.error(`Section not found: section-${id}`);
                return; 
            }

            if(elem) { 
                document.querySelectorAll('.nav-link').forEach(a => a.classList.remove('active')); 
                elem.classList.add('active'); 
            }
            
            const titleMap = {'dashboard':'لوحة التحكم','assign-reports':'التقارير والإحصائيات','grading':'رصد الدرجات','structure':'الهيكل الدراسي','users':'المستخدمين','students':'سجل الطلاب', 'mocks': 'الاختبارات المحاكية', 'comparisons': 'مقارنة النتائج', 'absentees': 'تقرير الغائبين', 'notifications': 'الإشعارات وملفات الطلاب', 'communication': 'سجل التواصل', 'grades-report': 'تقرير الدرجات الشامل'};
            document.getElementById('pageTitle').innerText = titleMap[id] || 'مدارس التعلم ثنائي اللغة العقيق';

            if(id === 'users') renderUsersTable();
            if(id === 'structure') renderStructureLists();
            if(id === 'students') renderStudents();
            if(id === 'grading') loadGradingOptions();
            if(id === 'dashboard') loadDashboardStats();
            if(id === 'assign-reports') populateReportDropdowns();
            if(id === 'mocks') { renderMocks(); window.updateMockItemOptions(); }
            if(id === 'comparisons') populateComparisonDropdowns();
            if(id === 'grades-report') window.updateGradesReportOptions();
            
            if(id === 'absentees') window.updateAbsOptions();
            if(id === 'notifications') window.renderNotificationsSummary();
            if(id === 'communication') window.initCommunicationForm();
        }

        // --- Core Functions (Structure) ---
        window.addStruct = function(type) {
            let inp = document.getElementById(type==='subjects'?'newSubjectName':type==='levels'?'newLevelName':'newClassName');
            if(inp.value) { 
                if(!DB[type]) DB[type] = []; 
                DB[type].push(inp.value); 
                saveData(type, DB[type]); // Optimized Save
                renderStructureLists(); 
                inp.value=''; populateDropdowns(); 
            }
        }
        window.addWeekStruct = function() {
            let n = document.getElementById('newWeekName').value, h = document.getElementById('newWeekHW').value;
            if(n && h) { 
                if(!DB.weeks) DB.weeks = []; 
                DB.weeks.push({name:n, hw:parseInt(h)}); 
                saveData('weeks', DB.weeks); // Optimized Save
                renderStructureLists(); 
            }
        }
        function renderStructureLists() {
            ['subjects','levels','classes'].forEach(t => {
                if(!DB[t]) DB[t] = [];
                document.getElementById(`list-${t}`).innerHTML = DB[t].map(x => `<li class="list-group-item d-flex justify-content-between">${x} <button class="btn btn-sm btn-danger" onclick="window.delStruct('${t}','${x}')">x</button></li>`).join('');
            });
            if(!DB.weeks) DB.weeks = [];
            document.getElementById('list-weeks').innerHTML = DB.weeks.map((x,i)=>`<tr><td>${x.name}</td><td>${x.hw}</td><td><button class="btn btn-sm btn-danger" onclick="window.delWeek(${i})">x</button></td></tr>`).join('');
        }
        window.delStruct = function(t,v){ DB[t]=DB[t].filter(x=>x!==v); saveData(t, DB[t]); renderStructureLists(); }
        window.delWeek = function(i){ DB.weeks.splice(i,1); saveData('weeks', DB.weeks); renderStructureLists(); }

        window.toggleTeacherFields = function() { document.getElementById('teacherFields').style.display = document.getElementById('uRole').value==='teacher'?'block':'none'; }
        window.createNewUser = function() {
            let u={
                id:Date.now(), 
                username:document.getElementById('uUsername').value, 
                fullName:document.getElementById('uFullName').value, 
                role:document.getElementById('uRole').value, 
                phone:document.getElementById('uPhone').value || '',
                password: Math.random().toString(36).slice(-6), 
                active:true
            };
            if(u.role==='teacher') { u.subject=document.getElementById('uSubject').value; u.classes=Array.from(document.getElementById('uClasses').selectedOptions).map(o=>o.value); }
            if(u.username) { 
                if(!DB.users) DB.users = []; 
                DB.users.push(u); 
                saveData('users', DB.users); 
                renderUsersTable(); 
                alert('كلمة المرور: '+u.password); 
            }
        }
        
        function renderUsersTable() {
            if(!DB.users) DB.users = [];
            document.getElementById('usersTableBody').innerHTML = DB.users.map(u => {
                const isActive = u.active !== false;
                const activeBtnClass = isActive ? 'btn-success' : 'btn-secondary';
                const activeIcon = isActive ? 'fa-check' : 'fa-ban';
                return `<tr>
                    <td>${u.fullName}</td><td>${u.username}</td><td>${u.phone || '-'}</td><td>${getRoleAr(u.role)}</td><td class="text-danger font-monospace">${u.password}</td>
                    <td>
                        <button class="btn btn-sm btn-warning text-dark me-1" onclick="window.viewUserPass(${u.id})" title="كشف كلمة المرور"><i class="fas fa-eye"></i></button>
                        <button class="btn btn-sm btn-info text-white me-1" onclick="window.editUserModal(${u.id})" title="تعديل"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm ${activeBtnClass} me-1" onclick="window.toggleUserActive(${u.id})" title="${isActive?'إيقاف':'تفعيل'}"><i class="fas ${activeIcon}"></i></button>
                        <button class="btn btn-sm btn-danger" onclick="window.delUser(${u.id})" title="حذف"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>`;
            }).join('');
        }
        window.delUser = function(id) { if(confirm('حذف؟')) { DB.users=DB.users.filter(x=>x.id!==id); saveData('users', DB.users); renderUsersTable(); } }
        window.viewUserPass = function(id) { const u = DB.users.find(x => x.id === id); if(u) alert('كلمة المرور للمستخدم ' + u.fullName + ' هي:\n' + u.password); }
        window.editUserModal = function(id) { 
            const u = DB.users.find(x => x.id === id); 
            if(!u) return; 
            document.getElementById('edit_uid').value = u.id; 
            document.getElementById('edit_name').value = u.fullName; 
            document.getElementById('edit_phone').value = u.phone || ''; 
            document.getElementById('edit_pass').value = ''; 
            editModalBS.show(); 
        }
        window.saveUserEdit = function() { 
            const id = parseInt(document.getElementById('edit_uid').value); 
            const uIdx = DB.users.findIndex(x => x.id === id); 
            if(uIdx > -1) { 
                DB.users[uIdx].fullName = document.getElementById('edit_name').value; 
                DB.users[uIdx].phone = document.getElementById('edit_phone').value;
                const newPass = document.getElementById('edit_pass').value; 
                if(newPass && newPass.trim() !== "") { DB.users[uIdx].password = newPass; } 
                saveData('users', DB.users); 
                renderUsersTable(); 
                editModalBS.hide(); 
            } 
        }
        window.toggleUserActive = function(id) { const uIdx = DB.users.findIndex(x => x.id === id); if(uIdx > -1) { const current = DB.users[uIdx].active !== false; DB.users[uIdx].active = !current; saveData('users', DB.users); renderUsersTable(); } }
        window.openProfileModal = function() { document.getElementById('my_new_pass').value = ''; profileModalBS.show(); }
        window.saveMyPassword = function() { const newPass = document.getElementById('my_new_pass').value; if(!newPass || newPass.trim() === "") { alert('الرجاء إدخال كلمة مرور جديدة'); return; } DB.currentUser.password = newPass; if(DB.currentUser.role !== 'admin' || DB.currentUser.username !== 'Mahmoud') { const uIdx = DB.users.findIndex(x => x.id === DB.currentUser.id); if(uIdx > -1) { DB.users[uIdx].password = newPass; } saveData('users', DB.users); } alert('تم تغيير كلمة المرور بنجاح'); profileModalBS.hide(); }

        window.addStudentModal = function() { let name = prompt('اسم الطالب:'); let lvl = prompt('الصف (مثال: الأول الثانوي):'); let cls = prompt('الفصل (مثال: 101):'); if(name && lvl && cls) { if(!DB.students) DB.students = []; DB.students.push({id:Date.now(), name, level:lvl, class:cls, sPhone:'966500000000', pPhone:'966500000000'}); saveData('students', DB.students); renderStudents(); } }
        
        window.renderStudents = function() {
            if(!DB.students) DB.students = [];
            let fL = document.getElementById('filterLevel').value, fC = document.getElementById('filterClass').value;
            let list = DB.students.filter(s => (!fL || s.level===fL) && (!fC || s.class===fC));
            document.querySelector('#studentsTable tbody').innerHTML = list.map(s => `<tr><td>${s.name}</td><td>${s.level}</td><td>${s.class}</td><td>${s.sPhone}</td><td>${s.pPhone}</td><td><button class="btn btn-sm btn-info text-white me-1" onclick="window.editStudentMeta(${s.id})"><i class="fas fa-edit"></i> تعديل</button><button class="btn btn-sm btn-danger" onclick="window.delStudent(${s.id})">حذف</button></td></tr>`).join('');
        }
        window.delStudent = function(id) { DB.students=DB.students.filter(s=>s.id!==id); saveData('students', DB.students); renderStudents(); }

        window.editStudentMeta = function(id) {
            const s = DB.students.find(x => x.id === id);
            if(!s) return;
            const newLvl = prompt('تعديل الصف:', s.level);
            if(newLvl === null) return;
            const newCls = prompt('تعديل الفصل:', s.class);
            if(newCls === null) return;
            
            if(newLvl && newCls) {
                s.level = newLvl;
                s.class = newCls;
                
                if(DB.grades) {
                    DB.grades.forEach(g => {
                        if(g.studentId == id) { g.class = newCls; }
                    });
                }
                
                // Save both updated collections
                saveData('students', DB.students);
                saveData('grades', DB.grades);
                renderStudents();
                window.showToast('تم تعديل بيانات الطالب وترحيل سجلاته', 'success');
            }
        }

        // Import
        window.downloadTemplate = function() { const headers = [["الاسم", "الصف", "الفصل", "جوال الطالب", "جوال الولي"]]; const wb = XLSX.utils.book_new(); const ws = XLSX.utils.aoa_to_sheet(headers); XLSX.utils.book_append_sheet(wb, ws, "Students"); XLSX.writeFile(wb, "Student_Template.xlsx"); }
        const excelInput = document.getElementById('excelImport');
        if (excelInput) {
            excelInput.addEventListener('change', function(e) {
                const file = e.target.files[0]; if (!file) return; const reader = new FileReader();
                reader.onload = function(e) {
                    const data = new Uint8Array(e.target.result); const workbook = XLSX.read(data, {type: 'array'}); const worksheet = workbook.Sheets[workbook.SheetNames[0]]; const json = XLSX.utils.sheet_to_json(worksheet, {header: 1});
                    if (json.length > 1) { if (!DB.students) DB.students = []; let count = 0;
                        for (let i = 1; i < json.length; i++) { const row = json[i]; if (row.length > 0 && row[0]) { DB.students.push({ id: Date.now() + i, name: row[0] || "", level: row[1] || "", class: row[2] || "", sPhone: row[3] || "966500000000", pPhone: row[4] || "966500000000" }); count++; } }
                        saveData('students', DB.students); renderStudents(); alert(`تم استيراد ${count} طالب بنجاح`);
                    } else { alert("الملف فارغ أو لا يحتوي على بيانات صحيحة"); } document.getElementById('excelImport').value = "";
                }; reader.readAsArrayBuffer(file);
            });
        }

        // Grading Logic
        function loadGradingOptions() { const t = DB.currentUser; const cls = t.role==='teacher' ? t.classes : DB.classes; document.getElementById('gradingClass').innerHTML = cls.map(c=>`<option value="${c}">${c}</option>`).join(''); document.getElementById('gradingWeek').innerHTML = DB.weeks.map(w=>`<option value="${w.name}">${w.name}</option>`).join(''); window.loadGradingSheet(); }
        
        window.loadGradingSheet = function() {
            const cls = document.getElementById('gradingClass').value, wkName = document.getElementById('gradingWeek').value;
            if(!DB.weeks) DB.weeks = []; const wk = DB.weeks.find(w=>w.name===wkName); if(!wk) return;
            const subj = DB.currentUser.role==='teacher' ? DB.currentUser.subject : DB.subjects[0];
            if(!DB.grades) DB.grades = [];
            let config = DB.grades.find(g => g.type === 'config' && g.week === wkName && g.subject === subj && g.class === cls) || { maxHw: Array(wk.hw).fill(10), maxMock: 20 };
            
            // REMOVED 'Attendance' Column Header entirely
            let hRow1 = `<tr><th rowspan="2" class="align-middle">اسم الطالب</th>`; let hRow2 = `<tr>`;
            for(let i=1; i<=wk.hw; i++) { hRow1 += `<th style="min-width:120px">واجب ${i}</th>`; hRow2 += `<th><input type="number" class="form-control form-control-sm text-center max-score-input" value="${config.maxHw[i-1] || 10}" onchange="window.recalcAllStats()"></th>`; }
            hRow1 += `<th style="min-width:120px">محاكي</th>`; hRow2 += `<th><input type="number" class="form-control form-control-sm text-center max-score-input" value="${config.maxMock || 20}" onchange="window.recalcAllStats()"></th>`;
            hRow1 += `<th rowspan="2" class="align-middle bg-light">المجموع</th><th rowspan="2" class="align-middle bg-light">النسبة %</th><th rowspan="2" class="align-middle"><button onclick="window.sendAllWA()" class="btn btn-success btn-sm w-100"><i class="fab fa-whatsapp"></i> الكل</button></th></tr>`; hRow2 += `</tr>`;
            
            document.getElementById('gradingHeader').innerHTML = hRow1 + hRow2;
            if(!DB.students) DB.students = []; const st = DB.students.filter(s=>s.class===cls);
            
            document.getElementById('gradingBody').innerHTML = st.map(s => {
                let r = DB.grades.find(g=>g.studentId==s.id && g.week===wkName && g.subject===subj) || {hw:[], mock:0, absent:false};
                let inps = '';
                
                // Render HW Inputs with Button
                for(let i=0; i<wk.hw; i++) { 
                    let v = r.hw[i]!==undefined ? r.hw[i] : '';
                    let isItemAbsent = v === 'abs';
                    let displayVal = isItemAbsent ? 'غ' : v;
                    let inputClass = isItemAbsent ? 'abs-input' : '';
                    let btnClass = isItemAbsent ? 'btn-danger' : 'btn-outline-secondary';
                    
                    inps += `<td>
                                <div class="input-group input-group-sm flex-nowrap">
                                    <input type="text" class="form-control text-center hw-inp ${inputClass}" 
                                        value="${displayVal}" 
                                        oninput="window.calcRowStats(this.closest('tr'))"
                                        ${isItemAbsent ? 'readonly' : ''}>
                                    <button class="btn ${btnClass}" type="button" tabindex="-1" onclick="window.toggleCellAbsence(this)">
                                        <i class="fas fa-user-times"></i>
                                    </button>
                                </div>
                            </td>`; 
                }

                // Render Mock Input with Button
                let mVal = r.mock!==undefined ? r.mock : '';
                let isMockAbsent = mVal === 'abs';
                let displayMock = isMockAbsent ? 'غ' : mVal;
                let mockInputClass = isMockAbsent ? 'abs-input' : '';
                let mockBtnClass = isMockAbsent ? 'btn-danger' : 'btn-outline-secondary';

                return `<tr data-sid="${s.id}" data-phone="${s.pPhone}" data-name="${s.name}">
                    <td class="text-start fw-bold">${s.name}</td>
                    ${inps}
                    <td>
                        <div class="input-group input-group-sm flex-nowrap">
                            <input type="text" class="form-control text-center mock-inp ${mockInputClass}" 
                                value="${displayMock}" 
                                oninput="window.calcRowStats(this.closest('tr'))"
                                ${isMockAbsent ? 'readonly' : ''}>
                            <button class="btn ${mockBtnClass}" type="button" tabindex="-1" onclick="window.toggleCellAbsence(this)">
                                <i class="fas fa-user-times"></i>
                            </button>
                        </div>
                    </td>
                    <td class="bg-light fw-bold text-primary total-cell">0</td><td class="bg-light pct-cell">0%</td>
                    <td><button onclick="window.sendSingleWA('${s.pPhone}', '${s.name}', this.closest('tr'))" class="btn btn-outline-success btn-sm border-0"><i class="fab fa-whatsapp fa-lg"></i></button></td></tr>`;
            }).join(''); window.recalcAllStats();
        }

        window.toggleCellAbsence = function(btn) {
            const input = btn.previousElementSibling;
            if (input.value === 'غ') {
                input.value = '';
                input.readOnly = false;
                input.classList.remove('abs-input');
                btn.classList.remove('btn-danger');
                btn.classList.add('btn-outline-secondary');
            } else {
                input.value = 'غ';
                input.readOnly = true;
                input.classList.add('abs-input');
                btn.classList.remove('btn-outline-secondary');
                btn.classList.add('btn-danger');
            }
            window.calcRowStats(btn.closest('tr'));
        }

        window.calcRowStats = function(tr) {
            let totalScore = 0; let totalMax = 0; 
            const hwInps = tr.querySelectorAll('.hw-inp'); 
            const maxInps = document.querySelectorAll('.max-score-input');
            
            const safeVal = (v) => (v === 'غ' || v === 'abs') ? 0 : (parseFloat(v) || 0);

            hwInps.forEach((inp, idx) => { totalScore += safeVal(inp.value); totalMax += parseFloat(maxInps[idx].value) || 0; });
            
            const mockInp = tr.querySelector('.mock-inp'); 
            totalScore += safeVal(mockInp.value); 
            totalMax += parseFloat(maxInps[maxInps.length-1].value) || 0;
            
            tr.querySelector('.total-cell').innerText = totalScore; let pct = totalMax > 0 ? Math.round((totalScore / totalMax) * 100) : 0;
            let pctBadge = pct >= 80 ? 'text-success' : pct >= 50 ? 'text-warning' : 'text-danger'; tr.querySelector('.pct-cell').innerHTML = `<span class="${pctBadge}">${pct}%</span>`;
        }
        
        window.recalcAllStats = function() { document.querySelectorAll('#gradingBody tr').forEach(tr => window.calcRowStats(tr)); }
        
        window.saveGrades = async function() {
            const cls = document.getElementById('gradingClass').value;
            const wkName = document.getElementById('gradingWeek').value;
            const subj = DB.currentUser.role === 'teacher' ? DB.currentUser.subject : DB.subjects[0];
            
            window.showToast('جاري سحب أحدث البيانات لضمان عدم الحذف...', 'info');

            let serverGrades = [];
            try {
                const snapshot = await get(child(dbRef, 'schoolSystem/grades'));
                if(snapshot.exists()) {
                    serverGrades = snapshot.val();
                } else {
                    serverGrades = DB.grades || [];
                }
            } catch(e) {
                console.warn("Could not fetch latest grades, using local cache.", e);
                serverGrades = DB.grades || [];
            }

            if (!Array.isArray(serverGrades)) serverGrades = [];

            const maxInps = document.querySelectorAll('.max-score-input');
            let maxHw = []; for(let i=0; i<maxInps.length-1; i++) maxHw.push(maxInps[i].value); let maxMock = maxInps[maxInps.length-1].value;
            
            serverGrades = serverGrades.filter(g => !(g.type === 'config' && g.week === wkName && g.subject === subj && g.class === cls));
            serverGrades.push({ type:'config', week:wkName, subject:subj, class:cls, maxHw, maxMock });
            
            document.querySelectorAll('#gradingBody tr').forEach(tr => {
                let sid = tr.getAttribute('data-sid'); 
                const parseStore = (v) => v === 'غ' ? 'abs' : v;
                
                let hw = Array.from(tr.querySelectorAll('.hw-inp')).map(i=>parseStore(i.value)); 
                let mock = parseStore(tr.querySelector('.mock-inp').value); 
                
                serverGrades = serverGrades.filter(g => !(g.studentId == sid && g.week === wkName && g.subject === subj));
                serverGrades.push({studentId:sid, week:wkName, subject:subj, hw, mock, class:cls, absent: false});
            }); 
            
            DB.grades = serverGrades;
            saveData('grades', serverGrades); 
        }

        // --- NEW: Grades Report Logic ---
        window.updateGradesReportOptions = function() {
            const fill = (id, opts) => document.getElementById(id).innerHTML = opts;
            if(!DB.weeks) DB.weeks = []; if(!DB.levels) DB.levels = []; if(!DB.classes) DB.classes = [];
            
            // Only refill if empty to avoid reset loop
            if(document.getElementById('grLevel').options.length <= 1) {
                fill('grLevel', `<option value="all">الكل</option>` + DB.levels.map(l=>`<option>${l}</option>`).join(''));
                fill('grClass', `<option value="all">الكل</option>` + DB.classes.map(c=>`<option>${c}</option>`).join(''));
                fill('grWeek', `<option value="all">الجميع</option>` + DB.weeks.map(w=>`<option value="${w.name}">${w.name}</option>`).join(''));
            }

            const type = document.getElementById('grType').value;
            const weekName = document.getElementById('grWeek').value;
            const week = DB.weeks.find(w=>w.name === weekName);

            let html = `<option value="all">الجميع</option>`;
            if (weekName !== 'all' && week) {
                if(type === 'hw' || type === 'both') {
                    for(let i=1; i<=week.hw; i++) html += `<option value="hw-${i}">واجب ${i}</option>`;
                }
                if(type === 'mock' || type === 'both') {
                    html += `<option value="mock">اختبار محاكي ${weekName}</option>`;
                }
            }
            document.getElementById('grItem').innerHTML = html;
        }

        const safeParse = (v) => (v === 'abs' || v === 'غ') ? 0 : (parseInt(v) || 0);

        window.renderGradesReport = function() {
            const lvl = document.getElementById('grLevel').value;
            const cls = document.getElementById('grClass').value;
            const type = document.getElementById('grType').value;
            const weekName = document.getElementById('grWeek').value;
            const item = document.getElementById('grItem').value; // 'all', 'hw-1', 'mock'

            let students = DB.students.filter(s => (lvl==='all' || s.level===lvl) && (cls==='all' || s.class===cls));
            
            let thead = `<tr><th>م</th><th>الطالب</th><th>الفصل</th>`;
            DB.subjects.forEach(s => thead += `<th>${s}</th>`);
            thead += `<th>المجموع</th><th>النسبة %</th><th>غياب (اختبار)</th><th>إشعارات</th><th>تواصل</th><th>خيارات</th></tr>`;
            document.querySelector('#gradesReportTable thead').innerHTML = thead;

            let rows = students.map((s, idx) => {
                let totalScore = 0;
                let totalMax = 0;
                let absentExams = 0;
                let tds = '';

                DB.subjects.forEach(sub => {
                    let subScore = 0;
                    let subMax = 0;
                    
                    // Iterate weeks based on selection
                    const targetWeeks = (weekName === 'all') ? DB.weeks : DB.weeks.filter(w => w.name === weekName);

                    targetWeeks.forEach(w => {
                        let g = DB.grades.find(x => x.studentId == s.id && x.week === w.name && x.subject === sub);
                        if(g) {
                            let conf = DB.grades.find(c => c.type === 'config' && c.week === w.name && c.subject === sub && c.class === s.class) || {maxHw: Array(w.hw).fill(10), maxMock: 20};
                            
                            // Calculate based on Type & Item
                            if(type === 'both' || type === 'hw') {
                                if(item === 'all' || item.startsWith('hw-')) {
                                    g.hw.forEach((val, i) => {
                                        if(item === 'all' || item === `hw-${i+1}`) {
                                            subScore += safeParse(val);
                                            subMax += parseInt(conf.maxHw[i] || 10);
                                        }
                                    });
                                }
                            }
                            if(type === 'both' || type === 'mock') {
                                if(item === 'all' || item === 'mock') {
                                    subScore += safeParse(g.mock);
                                    subMax += parseInt(conf.maxMock || 20);
                                    if(g.mock === 'abs' || g.mock === 'غ') absentExams++;
                                }
                            }
                        }
                    });
                    
                    totalScore += subScore;
                    totalMax += subMax;
                    tds += `<td>${subScore} / ${subMax}</td>`;
                });

                let pct = totalMax > 0 ? Math.round((totalScore / totalMax) * 100) : 0;
                
                // Count Notifs & Comms
                const notifs = (DB.communications || []).filter(c => c.studentId == s.id).length;
                const comms = notifs; // Simplified logic as per code structure, usually separate but using same array here

                return `<tr data-sid="${s.id}">
                    <td>${idx+1}</td>
                    <td class="fw-bold">${s.name}</td>
                    <td>${s.class}</td>
                    ${tds}
                    <td class="bg-light fw-bold">${totalScore}</td>
                    <td class="${pct>=50?'text-success':'text-danger'} fw-bold">${pct}%</td>
                    <td>${absentExams}</td>
                    <td>${notifs}</td>
                    <td>${comms}</td>
                    <td>
                        <button class="btn btn-outline-success btn-sm" onclick="window.sendDetailedWA('${s.id}', '${weekName}', false)">
                            <i class="fab fa-whatsapp"></i> ولي الأمر
                        </button>
                         <button class="btn btn-outline-primary btn-sm ms-1" onclick="window.sendDetailedWA('${s.id}', '${weekName}', true)">
                            <i class="fab fa-whatsapp"></i> الطالب
                        </button>
                    </td>
                </tr>`;
            }).join('');
            document.querySelector('#gradesReportTable tbody').innerHTML = rows;
        }

        window.sendDetailedWA = function(sid, weekName, toStudent=false) {
            const s = DB.students.find(x => x.id == sid);
            if(!s) return;
            
            const targetPhone = toStudent ? s.sPhone : s.pPhone;
            const title = toStudent ? `المكرم الطالب (${s.name})` : `المكرم ولي أمر الطالب (${s.name})`;
            
            // Calculate Stats On the Fly
            let totalScore = 0; let totalMax = 0;
            let mockAbs = 0; let hwAbs = 0;
            let subjectsStats = {};
            
            const targetWeeks = (weekName === 'all') ? DB.weeks : DB.weeks.filter(w => w.name === weekName);
            
            // Calculate HW Abs (Cumulative or Scope? Prompt says "Total absence in homework", usually cumulative. Let's do Cumulative)
            DB.weeks.forEach(w => {
                DB.subjects.forEach(sub => {
                    let g = DB.grades.find(x => x.studentId == sid && x.week === w.name && x.subject === sub);
                    if(g) {
                        g.hw.forEach(v => { if(v==='abs' || v==='غ') hwAbs++; });
                    }
                });
            });

            // Calculate Mock Abs & Scores (Scope based)
            targetWeeks.forEach(w => {
                DB.subjects.forEach(sub => {
                    if(!subjectsStats[sub]) subjectsStats[sub] = {s:0, m:0};
                    let g = DB.grades.find(x => x.studentId == sid && x.week === w.name && x.subject === sub);
                    if(g) {
                        let conf = DB.grades.find(c => c.type === 'config' && c.week === w.name && c.subject === sub && c.class === s.class) || {maxHw: Array(w.hw).fill(10), maxMock: 20};
                        
                        let subSum = 0; let subMaxSum = 0;
                        g.hw.forEach((v,i) => { subSum += safeParse(v); subMaxSum += parseInt(conf.maxHw[i]||10); });
                        subSum += safeParse(g.mock); subMaxSum += parseInt(conf.maxMock||20);
                        
                        if(g.mock === 'abs' || g.mock === 'غ') mockAbs++;
                        
                        subjectsStats[sub].s += subSum;
                        subjectsStats[sub].m += subMaxSum;
                        totalScore += subSum;
                        totalMax += subMaxSum;
                    }
                });
            });

            let pct = totalMax > 0 ? Math.round((totalScore / totalMax) * 100) : 0;
            
            const getSubPct = (name) => {
                const key = Object.keys(subjectsStats).find(k => k.includes(name) || name.includes(k));
                if(key && subjectsStats[key].m > 0) return Math.round((subjectsStats[key].s / subjectsStats[key].m)*100) + '%';
                return '0%';
            };

            const notifs = (DB.communications || []).filter(c => c.studentId == sid).length;
            const comms = notifs; // Simplified

            let msg = `${title} نحيطك علما بان التقريرالخاص بابنكم هذا الاسبوع متوسط النسبة المتوسط العام والنسبة ${pct}% ونسبته في مادة الاحياء هي ${getSubPct('أحياء')} والكيمياء هي ${getSubPct('كيمياء')} والرياضيات هي ${getSubPct('رياضيات')} والفيزياء هي ${getSubPct('فيزياء')} عدد أيام الغياب في الاختبارات لهذا الاسبوع ${mockAbs} عدد الغياب الاجمالي في الواجبات ${hwAbs} وهذا الاشعار رقم ${notifs} بناء على الاشعارات الموجودة في المنصة ${notifs} وعدد التواصل ${comms}`;

            // Save Communication Log
             if(!DB.communications) DB.communications = [];
             DB.communications.push({
                id: Date.now(),
                studentId: sid,
                date: new Date().toISOString().split('T')[0],
                action: 'واتساب',
                reason: `تقرير ${weekName}`,
                reply: ''
            });
            saveData('communications', DB.communications);

            window.open(`https://wa.me/${targetPhone}?text=${encodeURIComponent(msg)}`, '_blank');
        }

        // --- Reports ---
        function populateReportDropdowns() {
            const fill = (id, opts) => document.getElementById(id).innerHTML = opts;
            if(!DB.weeks) DB.weeks = []; if(!DB.levels) DB.levels = []; if(!DB.classes) DB.classes = []; if(!DB.subjects) DB.subjects = [];
            const weeks = DB.weeks.map(w=>`<option value="${w.name}">${w.name}</option>`).join('');
            const levels = `<option value="all">الكل</option>` + DB.levels.map(l=>`<option>${l}</option>`).join('');
            const classes = `<option value="all">الكل</option>` + DB.classes.map(c=>`<option>${c}</option>`).join('');
            const subjects = DB.subjects.map(s=>`<option>${s}</option>`).join('');
            fill('arLevel', levels); fill('arClass', classes); fill('arWeek', `<option value="all">الكل</option>`+weeks); fill('arSubject', subjects);
            fill('hwRepLevel', levels); fill('hwRepClass', classes); fill('hwRepWeek', weeks); window.updateHwOptions(); 
            fill('stRepLevel', levels); fill('stRepClass', classes); fill('stRepSubject', `<option value="all">الجميع</option>`+subjects); fill('stRepWeek', weeks);
            fill('expLevel', levels); fill('expClass', classes); fill('expSubject', `<option value="all">الجميع</option>`+subjects); fill('expWeek', `<option value="all">تراكمي</option>`+weeks);
        }
        window.updateHwOptions = function() {
            const type = document.getElementById('hwRepType').value; const weekName = document.getElementById('hwRepWeek').value;
            const week = DB.weeks.find(w=>w.name === weekName) || DB.weeks[0];
            let html = `<option value="all">الجميع</option>`;
            if(type === 'hw' && week) { for(let i=1; i<=week.hw; i++) html += `<option value="${i}">واجب ${i}</option>`; } else { html += `<option value="1">محاكي ${weekName}</option>`; }
            document.getElementById('hwRepItem').innerHTML = html;
        }

        window.renderHomeworkReport = function() {
            const lvl = document.getElementById('hwRepLevel').value; const cls = document.getElementById('hwRepClass').value;
            const type = document.getElementById('hwRepType').value; const item = document.getElementById('hwRepItem').value; const week = document.getElementById('hwRepWeek').value;
            document.getElementById('reportTitle').innerText = `تقرير ${type==='hw'?'الواجبات':'الاختبارات'} - ${week}`; document.getElementById('statsDashboard').classList.add('hidden');
            if(!DB.students) DB.students = []; let students = DB.students.filter(s => (lvl==='all' || s.level===lvl) && (cls==='all' || s.class===cls));
            let thead = `<tr><th>م</th><th>الطالب</th><th>الفصل</th>`; DB.subjects.forEach(s => thead += `<th>${s}</th>`); 
            thead += `<th>واتساب</th></tr>`; 
            document.querySelector('#assignReportTable thead').innerHTML = thead;
            
            let rows = students.map((s, idx) => {
                let tds = DB.subjects.map(sub => {
                    if(!DB.grades) DB.grades = []; let g = DB.grades.find(x => x.studentId == s.id && x.week === week && x.subject === sub);
                    if(!g) return `<td class="text-muted">-</td>`; 
                    let val = '-'; 
                    if(type === 'hw') { 
                        if(item === 'all') val = g.hw.reduce((a,b)=> safeParse(a) + safeParse(b), 0); 
                        else val = g.hw[parseInt(item)-1] === 'abs' ? 'غ' : (g.hw[parseInt(item)-1] || 0); 
                    } else { 
                        val = g.mock === 'abs' ? 'غ' : (g.mock || 0); 
                    }
                    return `<td>${val}</td>`;
                }).join(''); 
                return `<tr><td>${idx+1}</td><td>${s.name}</td><td>${s.class}</td>${tds}
                <td>
                    <button class="btn btn-sm btn-success" onclick="window.sendDetailedWA('${s.id}', '${week}', false)"><i class="fab fa-whatsapp"></i> ولي الأمر</button>
                    <button class="btn btn-sm btn-outline-success" onclick="window.sendDetailedWA('${s.id}', '${week}', true)"><i class="fab fa-whatsapp"></i> الطالب</button>
                </td></tr>`;
            }).join(''); document.querySelector('#assignReportTable tbody').innerHTML = rows;
        }

        // --- Missing Details Modal Logic ---
        window.showMissingDetails = function(lvl, cls, sub, wk) {
            const containerTable = document.getElementById('missingGradesTable');
            const thead = containerTable.querySelector('thead');
            const tbody = containerTable.querySelector('tbody');
            
            const students = DB.students.filter(s => s.level === lvl && s.class === cls);
            const weekObj = DB.weeks.find(w => w.name === wk);
            const numHW = weekObj ? weekObj.hw : 0;
            
            let headerHTML = '<tr><th>الطالب</th>';
            for(let i=1; i<=numHW; i++) headerHTML += `<th>واجب ${i}</th>`;
            headerHTML += '<th>محاكي</th></tr>';
            thead.innerHTML = headerHTML;
            
            let bodyHTML = '';
            students.forEach(s => {
                let g = DB.grades.find(gr => gr.studentId == s.id && gr.week === wk && gr.subject === sub);
                let isMissingSomething = false;
                if(!g) {
                    isMissingSomething = true;
                } else {
                    for(let i=0; i<numHW; i++) {
                        if(g.hw[i] === undefined || g.hw[i] === null || g.hw[i] === '') isMissingSomething = true;
                    }
                    if(g.mock === undefined || g.mock === null || g.mock === '') isMissingSomething = true;
                }
                
                if (isMissingSomething) {
                    let row = `<tr><td class="fw-bold">${s.name}</td>`;
                    for(let i=0; i<numHW; i++) {
                        let val = g ? g.hw[i] : undefined;
                        let icon = (val !== undefined && val !== null && val !== '') ? '<i class="fas fa-check-circle text-success"></i>' : '<i class="fas fa-times-circle text-danger"></i>';
                        row += `<td>${icon}</td>`;
                    }
                    let mVal = g ? g.mock : undefined;
                    let mIcon = (mVal !== undefined && mVal !== null && mVal !== '') ? '<i class="fas fa-check-circle text-success"></i>' : '<i class="fas fa-times-circle text-danger"></i>';
                    row += `<td>${mIcon}</td>`;
                    row += '</tr>';
                    bodyHTML += row;
                }
            });
            tbody.innerHTML = bodyHTML || '<tr><td colspan="10">جميع الطلاب مكتملين</td></tr>';
            missingModalBS.show();
        }

        window.renderGradingStatusReport = function() {
            const wk = document.getElementById('stRepWeek').value; 
            const lvlFilter = document.getElementById('stRepLevel').value; 
            const clsFilter = document.getElementById('stRepClass').value; 
            const subFilter = document.getElementById('stRepSubject').value;
            
            document.getElementById('reportTitle').innerText = `حالة الرصد - ${wk}`; 
            document.getElementById('statsDashboard').classList.add('hidden');
            
            let thead = `<tr><th>المعلم</th><th>الصف</th><th>الفصل</th><th>المادة</th><th>الحالة</th><th>تنبيه المعلم</th><th>التفاصيل</th></tr>`; 
            document.querySelector('#assignReportTable thead').innerHTML = thead;
            
            if(!DB.students) DB.students = []; 
            if(!DB.grades) DB.grades = [];
            
            let activeCombinations = [];
            DB.students.forEach(s => {
                const combo = { level: s.level, class: s.class };
                if (!activeCombinations.some(c => c.level === combo.level && c.class === combo.class)) {
                    activeCombinations.push(combo);
                }
            });
            activeCombinations.sort((a, b) => (a.level + a.class).localeCompare(b.level + b.class));

            let reportRows = [];
            const targetSubjects = (subFilter === 'all') ? DB.subjects : [subFilter];

            activeCombinations.forEach(combo => {
                if (lvlFilter !== 'all' && combo.level !== lvlFilter) return;
                if (clsFilter !== 'all' && combo.class !== clsFilter) return;

                targetSubjects.forEach(s => {
                    let classStudents = DB.students.filter(stud => stud.class === combo.class && stud.level === combo.level);
                    let studentCount = classStudents.length;
                    
                    let fullyGradedCount = 0;
                    const weekObj = DB.weeks.find(w => w.name === wk);
                    const numHW = weekObj ? weekObj.hw : 0;

                    classStudents.forEach(st => {
                        let g = DB.grades.find(gr => gr.studentId == st.id && gr.week === wk && gr.subject === s);
                        if(g) {
                            let isComplete = true;
                            for(let i=0; i<numHW; i++) { if(g.hw[i] === undefined || g.hw[i] === null || g.hw[i] === '') isComplete = false; }
                            if(g.mock === undefined || g.mock === null || g.mock === '') isComplete = false;
                            if(isComplete) fullyGradedCount++;
                        }
                    });

                    let statusText = 'رصد جزئي';
                    let statusClass = 'bg-warning';
                    if(fullyGradedCount === studentCount && studentCount > 0) { statusText='مكتمل'; statusClass='bg-success'; }
                    else if(fullyGradedCount === 0) { statusText='لم يرصد'; statusClass='bg-danger'; }
                    
                    let statusBadge = `<span class="badge ${statusClass}">${statusText}</span>`;
                    let missingCount = studentCount - fullyGradedCount;
                    let detailBtn = (studentCount > 0 && missingCount > 0) ? `<span class="clickable-status" onclick="window.showMissingDetails('${combo.level}', '${combo.class}', '${s}', '${wk}')">${missingCount} طالب</span>` : '-';
                    
                    // Teacher Info
                    let teacher = DB.users.find(u => u.role === 'teacher' && u.subject === s && u.classes && u.classes.includes(combo.class));
                    let teacherName = teacher ? teacher.fullName : 'غير معين';
                    let teacherPhone = teacher ? teacher.phone : '';
                    
                    let notifyBtn = '-';
                    if(teacherPhone && missingCount > 0) {
                        notifyBtn = `<button class="btn btn-sm btn-outline-success" onclick="window.notifyTeacherStatus('${teacherPhone}', '${teacherName}', '${statusText}', '${s}', '${combo.class}', '${wk}', ${missingCount})"><i class="fab fa-whatsapp"></i> إشعار</button>`;
                    }

                    reportRows.push(`<tr><td>${teacherName}</td><td>${combo.level}</td><td>${combo.class}</td><td>${s}</td><td>${statusBadge}</td><td>${notifyBtn}</td><td>${detailBtn}</td></tr>`);
                });
            });
            document.querySelector('#assignReportTable tbody').innerHTML = reportRows.join('');
        }

        window.notifyTeacherStatus = function(phone, name, status, subj, cls, wk, count) {
            let msg = `المكرم الاستاذ / ${name}
نحيطكم علما أنه هناك : الحالة ${status}
لـ ${subj} - فصل ${cls} - ${wk}
وعدد الطلاب المتبقين ${count}`;
            window.open(`https://wa.me/${phone}?text=${encodeURIComponent(msg)}`, '_blank');
        }

        window.bulkNotifyTeachers = function() {
            const wk = document.getElementById('stRepWeek').value;
            if(!DB.students || !DB.grades) return;

            let teacherMap = {}; // phone -> {name, items: []}
            let activeCombinations = [];
            DB.students.forEach(s => {
                const combo = { level: s.level, class: s.class };
                if (!activeCombinations.some(c => c.level === combo.level && c.class === combo.class)) {
                    activeCombinations.push(combo);
                }
            });

            activeCombinations.forEach(combo => {
                DB.subjects.forEach(s => {
                    let classStudents = DB.students.filter(stud => stud.class === combo.class && stud.level === combo.level);
                    let studentCount = classStudents.length;
                    if(studentCount === 0) return;

                    let fullyGradedCount = 0;
                    const weekObj = DB.weeks.find(w => w.name === wk);
                    const numHW = weekObj ? weekObj.hw : 0;

                    classStudents.forEach(st => {
                        let g = DB.grades.find(gr => gr.studentId == st.id && gr.week === wk && gr.subject === s);
                        if(g) {
                            let isComplete = true;
                            for(let i=0; i<numHW; i++) { if(g.hw[i] === undefined || g.hw[i] === null || g.hw[i] === '') isComplete = false; }
                            if(g.mock === undefined || g.mock === null || g.mock === '') isComplete = false;
                            if(isComplete) fullyGradedCount++;
                        }
                    });

                    let missingCount = studentCount - fullyGradedCount;
                    if(missingCount > 0) {
                        let teacher = DB.users.find(u => u.role === 'teacher' && u.subject === s && u.classes && u.classes.includes(combo.class));
                        if(teacher && teacher.phone) {
                            if(!teacherMap[teacher.phone]) teacherMap[teacher.phone] = {name: teacher.fullName, items: []};
                            teacherMap[teacher.phone].items.push(`${s} - ${combo.class} (${missingCount} طالب)`);
                        }
                    }
                });
            });

            const phones = Object.keys(teacherMap);
            if(phones.length === 0) return alert('لا يوجد معلمين لديهم نقص في الرصد أو لا توجد أرقام جوال مسجلة');
            if(!confirm(`سيتم إرسال إشعارات لـ ${phones.length} معلم. هل أنت متأكد؟`)) return;

            phones.forEach((phone, i) => {
                let t = teacherMap[phone];
                let msg = `المكرم الاستاذ / ${t.name}
نحيطكم علما بوجود نقص في رصد الدرجات للأسبوع (${wk}) في الفصول التالية:
${t.items.join('\n')}
الرجاء استكمال الرصد في أقرب وقت.`;
                setTimeout(() => window.open(`https://wa.me/${phone}?text=${encodeURIComponent(msg)}`, '_blank'), i * 3000);
            });
        }

        window.renderExportPreview = function() { window.renderWeeklyGeneralReport(true); }
        
        function getTeacherName(cls, subj) {
            if (!DB.users) return '-';
            const t = DB.users.find(u => u.role === 'teacher' && u.subject === subj && u.classes && u.classes.includes(cls));
            return t ? t.fullName : '-';
        }

        window.renderWeeklyGeneralReport = function(isExportMode = false) {
            let lvl = isExportMode ? document.getElementById('expLevel').value : document.getElementById('arLevel').value;
            let cls = isExportMode ? document.getElementById('expClass').value : document.getElementById('arClass').value;
            let wk = isExportMode ? document.getElementById('expWeek').value : document.getElementById('arWeek').value;
            let specificSub = isExportMode ? document.getElementById('expSubject').value : 'all';
            document.getElementById('reportTitle').innerText = `تقرير الأداء العام - ${wk==='all'?'تراكمي':wk}`;
            if(!DB.students) DB.students = []; let students = DB.students.filter(s => (lvl==='all' || s.level===lvl) && (cls==='all' || s.class===cls));
            let subjectsToShow = (specificSub === 'all') ? DB.subjects : [specificSub];
            
            let thead = `<tr><th>م</th><th>الطالب</th><th>الفصل</th>`; 
            if(subjectsToShow.length === 1) thead += `<th>المعلم</th>`;
            subjectsToShow.forEach(sub => thead += `<th>${sub}</th>`); 
            thead += `<th>المجموع</th><th>النسبة %</th><th>الحالة</th><th>واتساب</th></tr>`; 
            document.querySelector('#assignReportTable thead').innerHTML = thead;
            
            if(!DB.grades) DB.grades = []; let reportData = [];
            let rows = students.map((s, idx) => {
                let rowTotal = 0; let absentCount = 0;
                let subCells = subjectsToShow.map(sub => {
                    let grades = DB.grades.filter(x => x.studentId == s.id && x.subject === sub && (wk==='all' || x.week === wk));
                    let subSum = 0; grades.forEach(g => { 
                         subSum += (g.hw.reduce((a,b)=>safeParse(a)+safeParse(b),0) + safeParse(g.mock)); 
                    });
                    rowTotal += subSum; return `<td>${subSum}</td>`;
                }).join('');
                
                let teacherCell = '';
                if(subjectsToShow.length === 1) {
                    teacherCell = `<td class="text-muted small">${getTeacherName(s.class, subjectsToShow[0])}</td>`;
                }

                let subjectsCount = subjectsToShow.length; let weeksCount = (wk==='all' ? DB.weeks.length : 1); let maxPossible = subjectsCount * 30 * weeksCount; 
                let pct = maxPossible > 0 ? Math.round((rowTotal / maxPossible) * 100) : 0; let status = pct >= 50 ? 'مجتاز' : 'غير مجتاز'; 
                reportData.push({ total: rowTotal, pct: pct });
                
                return `<tr><td>${idx+1}</td><td class="fw-bold text-start">${s.name}</td><td>${s.class}</td>${teacherCell}${subCells}<td class="fw-bold text-primary">${rowTotal}</td><td>${status==='غائب'?'غائب':pct+'%'}</td><td>${status}</td>
                <td>
                    <button class="btn btn-sm btn-success" onclick="window.sendDetailedWA('${s.id}', '${wk}', false)"><i class="fab fa-whatsapp"></i> ولي الأمر</button>
                    <button class="btn btn-sm btn-outline-success" onclick="window.sendDetailedWA('${s.id}', '${wk}', true)"><i class="fab fa-whatsapp"></i> الطالب</button>
                </td></tr>`;
            }).join(''); document.querySelector('#assignReportTable tbody').innerHTML = rows; if(!isExportMode) updateReportStats(reportData);
        }
        window.renderDetailedSubjectReport = function() {
            const lvl = document.getElementById('arLevel').value; const cls = document.getElementById('arClass').value;
            const wkName = document.getElementById('arWeek').value; const sub = document.getElementById('arSubject').value;
            if(wkName === 'all') { alert('التقرير التفصيلي لا يدعم العرض التراكمي حالياً'); return; }
            const wkObj = DB.weeks.find(w => w.name === wkName); if(!wkObj) return;
            document.getElementById('reportTitle').innerText = `تقرير تفصيلي - ${sub} - ${wkName}`; document.getElementById('statsDashboard').classList.add('hidden');
            if(!DB.students) DB.students = []; let students = DB.students.filter(s => (lvl==='all' || s.level===lvl) && (cls==='all' || s.class===cls));
            let thead = `<tr><th>م</th><th>الطالب</th><th>الفصل</th>`; for(let i=1; i<=wkObj.hw; i++) thead += `<th>واجب ${i}</th>`; thead += `<th>محاكي</th><th>المجموع</th></tr>`; document.querySelector('#assignReportTable thead').innerHTML = thead;
            if(!DB.grades) DB.grades = [];
            document.querySelector('#assignReportTable tbody').innerHTML = students.map((s, idx) => {
                let g = DB.grades.find(x => x.studentId == s.id && x.week === wkName && x.subject === sub) || {hw:[], mock:0};
                let hwCells = ''; let hwSum = 0; 
                for(let i=0; i<wkObj.hw; i++) { 
                    let v = g.hw ? g.hw[i] : 0; 
                    let display = v === 'abs' ? 'غ' : v;
                    hwSum += safeParse(v); 
                    hwCells += `<td>${display}</td>`; 
                }
                let total = hwSum + safeParse(g.mock);
                let mockDisp = g.mock === 'abs' ? 'غ' : (g.mock||0);
                return `<tr><td>${idx+1}</td><td class="fw-bold text-start">${s.name}</td><td>${s.class}</td>${hwCells}<td>${mockDisp}</td><td class="fw-bold bg-light">${total}</td></tr>`;
            }).join('');
        }

        window.populateDropdowns = function() {
            const fill = (id, opts) => { if(document.getElementById(id)) document.getElementById(id).innerHTML = opts; }
            fill('uSubject', DB.subjects.map(s=>`<option>${s}</option>`).join('')); fill('uClasses', DB.classes.map(c=>`<option>${c}</option>`).join(''));
            fill('gradingClass', DB.classes.map(c=>`<option>${c}</option>`).join('')); fill('gradingWeek', DB.weeks.map(w=>`<option>${w.name}</option>`).join(''));
            fill('filterLevel', `<option value="">الكل</option>` + DB.levels.map(l=>`<option>${l}</option>`).join('')); fill('filterClass', `<option value="">الكل</option>` + DB.classes.map(c=>`<option>${c}</option>`).join(''));
            fill('mockSubject', DB.subjects.map(s=>`<option>${s}</option>`).join('')); fill('mockLevel', DB.levels.map(l=>`<option>${l}</option>`).join(''));
            
            fill('absWeek', DB.weeks.map(w=>`<option value="${w.name}">${w.name}</option>`).join(''));
            fill('commLevel', `<option value="">اختر الصف</option>` + DB.levels.map(l=>`<option>${l}</option>`).join(''));
            fill('commClass', `<option value="">اختر الفصل</option>` + DB.classes.map(c=>`<option>${c}</option>`).join(''));
            
            fill('absLevel', `<option value="all">الكل</option>` + DB.levels.map(l=>`<option>${l}</option>`).join(''));
            fill('absClass', `<option value="all">الكل</option>` + DB.classes.map(c=>`<option>${c}</option>`).join(''));

            fill('notifLevel', `<option value="all">الكل</option>` + DB.levels.map(l=>`<option>${l}</option>`).join(''));
            fill('notifClass', `<option value="all">الكل</option>` + DB.classes.map(c=>`<option>${c}</option>`).join(''));
            
            // Mocks Filters - UPDATED
            fill('mockRepLevel', `<option value="all">الكل</option>` + DB.levels.map(l=>`<option>${l}</option>`).join(''));
            fill('mockRepClass', `<option value="all">الكل</option>` + DB.classes.map(c=>`<option>${c}</option>`).join(''));
            fill('mockRepWeek', `<option value="all">الجميع</option>` + DB.weeks.map(w=>`<option value="${w.name}">${w.name}</option>`).join(''));
        }
        window.exportTableToExcel = function(tableID, filename = '') { let elt = document.getElementById(tableID); let wb = XLSX.utils.table_to_book(elt, {sheet: "Sheet1"}); XLSX.writeFile(wb, (filename || 'Report') + '.xlsx'); }
        function updateReportStats(data) {
            if(data.length === 0) { document.getElementById('statsDashboard').classList.add('hidden'); return; } document.getElementById('statsDashboard').classList.remove('hidden');
            const scores = data.map(d => d.total); const avg = scores.length ? Math.round(scores.reduce((a,b)=>a+b,0) / scores.length) : 0;
            const max = scores.length ? Math.max(...scores) : 0; const min = scores.length ? Math.min(...scores) : 0;
            let pass = data.filter(d => d.pct >= 50).length; let fail = data.length - pass;
            if(reportCharts.pie) reportCharts.pie.destroy();
            reportCharts.pie = new Chart(document.getElementById('repPieChart'), { type: 'doughnut', data: { labels: ['مجتاز', 'غير مجتاز'], datasets: [{data: [pass, fail], backgroundColor: ['#28a745', '#dc3545']}] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {position:'bottom'} } } });
            let gradeDist = [0,0,0,0,0]; data.forEach(d => { if(d.pct>=90) gradeDist[0]++; else if(d.pct>=80) gradeDist[1]++; else if(d.pct>=70) gradeDist[2]++; else if(d.pct>=60) gradeDist[3]++; else gradeDist[4]++; });
            if(reportCharts.bar) reportCharts.bar.destroy();
            reportCharts.bar = new Chart(document.getElementById('repBarChart'), { type: 'bar', data: { labels: ['ممتاز', 'جيد جداً', 'جيد', 'مقبول', 'ضعيف'], datasets: [{label: 'عدد الطلاب', data: gradeDist, backgroundColor: '#1e3c72', borderRadius: 4}] }, options: { responsive: true, maintainAspectRatio: false, scales:{y:{beginAtZero:true, ticks:{stepSize:1}}} } });
            document.getElementById('statAvg').innerText = avg; document.getElementById('statHigh').innerText = max; document.getElementById('statLow').innerText = min;
        }

        // --- Simplified WA functions (Original) ---
        window.sendSingleWA = function(phone, name, tr) { 
            let total = tr.querySelector('.total-cell').innerText; 
            let pct = tr.querySelector('.pct-cell').innerText; 
            let msg = `ولي أمر الطالب ${name}،%0aمجموع درجات ابنكم: ${total} (${pct}).`; 
            
            if(!DB.communications) DB.communications = [];
            const studentId = tr.getAttribute('data-sid');
            DB.communications.push({
                id: Date.now(),
                studentId: studentId,
                date: new Date().toISOString().split('T')[0],
                action: 'واتساب',
                reason: 'إرسال تقرير الدرجات (فردي)',
                reply: ''
            });
            saveData('communications', DB.communications);

            window.open(`https://wa.me/${phone}?text=${msg}`, '_blank'); 
        }
        
        window.sendAllWA = function() { 
            const rows = document.querySelectorAll('#gradingBody tr'); 
            if(!rows.length) return; 
            if(!confirm(`إرسال لـ ${rows.length}؟`)) return; 
            
            if(!DB.communications) DB.communications = [];
            const today = new Date().toISOString().split('T')[0];

            rows.forEach((tr, i) => { 
                let phone = tr.getAttribute('data-phone'); 
                let name = tr.getAttribute('data-name'); 
                let sid = tr.getAttribute('data-sid');
                let total = tr.querySelector('.total-cell').innerText; 
                let pct = tr.querySelector('.pct-cell').innerText; 
                let msg = `ولي أمر الطالب ${name}،%0aمجموع درجات ابنكم: ${total} (${pct}).`; 
                
                DB.communications.push({
                    id: Date.now() + i,
                    studentId: sid,
                    date: today,
                    action: 'واتساب',
                    reason: 'إرسال تقرير الدرجات (جماعي)',
                    reply: ''
                });

                setTimeout(() => window.open(`https://wa.me/${phone}?text=${msg}`, '_blank'), i * 1000); 
            }); 
            saveData('communications', DB.communications);
        }
        
        function loadDashboardStats() {
            if(!DB.students) DB.students = []; if(!DB.users) DB.users = []; if(!DB.mocks) DB.mocks = [];
            document.getElementById('dashStudentCount').innerText = DB.students.length; document.getElementById('dashTeacherCount').innerText = DB.users.filter(u=>u.role==='teacher').length; document.getElementById('dashMockCount').innerText = DB.mocks.length;
            const ctx = document.getElementById('mainTrendChart');
            new Chart(ctx, { type: 'line', data: { labels: DB.weeks.map(w=>w.name), datasets: [{label:'متوسط الأداء', data:DB.weeks.map(()=>65+Math.random()*30), borderColor:'#1e3c72', tension:0.4, fill:true}] } });
        }

        // --- Mock Exams Update ---
        window.addMockExam = function() { document.getElementById('mockName').value = ''; document.getElementById('mockDate').value = ''; mockModalBS.show(); }
        window.saveMockExam = function() { 
            const name = document.getElementById('mockName').value; 
            const date = document.getElementById('mockDate').value; 
            const subject = document.getElementById('mockSubject').value; 
            const level = document.getElementById('mockLevel').value; 
            if(name && date) { 
                if(!DB.mocks) DB.mocks = []; 
                DB.mocks.push({ id: Date.now(), name, date, subject, level }); 
                saveData('mocks', DB.mocks); 
                renderMocks(); 
                mockModalBS.hide(); 
            } else { alert('الرجاء تعبئة جميع الحقول'); } 
        }
        window.renderMocks = function() { 
            if(!DB.mocks) DB.mocks = []; 
            document.querySelector('#mocksTable tbody').innerHTML = DB.mocks.map(m => `
                <tr>
                    <td>${m.name}</td>
                    <td>${m.date}</td>
                    <td>${m.subject}</td>
                    <td>${m.level}</td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="window.delMock(${m.id})">حذف</button>
                    </td>
                </tr>`).join(''); 
        }
        window.delMock = function(id) { if(confirm('هل أنت متأكد من الحذف؟')) { DB.mocks = DB.mocks.filter(m => m.id !== id); saveData('mocks', DB.mocks); renderMocks(); } }

        // --- NEW: Mock Report Logic & Specific WhatsApp ---
        window.updateMockItemOptions = function() {
            const weekName = document.getElementById('mockRepWeek').value;
            let html = `<option value="all">جميع الاختبارات المحاكية</option>`;
            if (weekName !== 'all') {
                html += `<option value="current">اختبار محاكي لهذا الأسبوع</option>`;
            }
            document.getElementById('mockRepItem').innerHTML = html;
        }

        window.renderMockGradesReport = function() {
            const lvl = document.getElementById('mockRepLevel').value;
            const cls = document.getElementById('mockRepClass').value;
            const weekName = document.getElementById('mockRepWeek').value;
            // Type is fixed to Mock
            
            if(!DB.students) DB.students = [];
            let students = DB.students.filter(s => (lvl==='all' || s.level===lvl) && (cls==='all' || s.class===cls));
            
            let thead = `<tr><th>م</th><th>الطالب</th><th>الفصل</th>`;
            DB.subjects.forEach(s => thead += `<th>${s}</th>`);
            thead += `<th>المعدل العام</th><th>النسبة %</th><th>غياب (محاكي)</th><th>واتساب</th></tr>`;
            document.querySelector('#mockReportTable thead').innerHTML = thead;

            let rows = students.map((s, idx) => {
                let totalScore = 0;
                let totalMax = 0;
                let absentExams = 0; // In selected scope
                let subjectStats = {};

                // Initialize Subject Stats
                DB.subjects.forEach(sub => subjectStats[sub] = {score:0, max:0, pct:0});

                // Calculate Totals and Stats based on filters
                const targetWeeks = (weekName === 'all') ? DB.weeks : DB.weeks.filter(w => w.name === weekName);
                
                DB.subjects.forEach(sub => {
                    let subScore = 0;
                    let subMax = 0;
                    
                    targetWeeks.forEach(w => {
                        let g = DB.grades.find(x => x.studentId == s.id && x.week === w.name && x.subject === sub);
                        if(g) {
                            let conf = DB.grades.find(c => c.type === 'config' && c.week === w.name && c.subject === sub && c.class === s.class) || {maxMock: 20};
                            // Only Mock grades
                            subScore += safeParse(g.mock);
                            subMax += parseInt(conf.maxMock || 20);
                            
                            if(g.mock === 'abs' || g.mock === 'غ') absentExams++;
                        }
                    });
                    
                    totalScore += subScore;
                    totalMax += subMax;
                    subjectStats[sub].score = subScore;
                    subjectStats[sub].max = subMax;
                    subjectStats[sub].pct = subMax > 0 ? Math.round((subScore/subMax)*100) : 0;
                });

                let pct = totalMax > 0 ? Math.round((totalScore / totalMax) * 100) : 0;
                
                let tds = DB.subjects.map(sub => `<td>${subjectStats[sub].score}</td>`).join('');

                return `<tr>
                    <td>${idx+1}</td>
                    <td class="fw-bold">${s.name}</td>
                    <td>${s.class}</td>
                    ${tds}
                    <td class="fw-bold">${totalScore} / ${totalMax}</td>
                    <td class="${pct>=50?'text-success':'text-danger'} fw-bold">${pct}%</td>
                    <td>${absentExams}</td>
                    <td>
                        <button class="btn btn-success btn-sm" onclick="window.sendDetailedWA('${s.id}', '${weekName}', false)">
                            <i class="fab fa-whatsapp"></i> ولي الأمر
                        </button>
                        <button class="btn btn-outline-success btn-sm" onclick="window.sendDetailedWA('${s.id}', '${weekName}', true)">
                            <i class="fab fa-whatsapp"></i> الطالب
                        </button>
                    </td>
                </tr>`;
            }).join('');
            document.querySelector('#mockReportTable tbody').innerHTML = rows;
        }

        // --- Absentees Report ---
        window.updateAbsOptions = function() {
            const weekName = document.getElementById('absWeek').value;
            const type = document.getElementById('absType').value;
            const week = DB.weeks.find(w => w.name === weekName);
            let html = '';
            if(type === 'hw' && week) { for(let i=1; i<=week.hw; i++) html += `<option value="${i}">واجب ${i}</option>`; } 
            else { html = `<option value="mock">اختبار محاكي</option>`; }
            document.getElementById('absItem').innerHTML = html;
        }

        window.renderAbsentees = function() {
            const week = document.getElementById('absWeek').value;
            const type = document.getElementById('absType').value;
            const item = document.getElementById('absItem').value;
            const lvl = document.getElementById('absLevel').value;
            const cls = document.getElementById('absClass').value;

            if(!DB.students) DB.students = [];
            if(!DB.grades) DB.grades = [];
            if(!DB.subjects) DB.subjects = [];

            let thead = `<tr>
                <th rowspan="2" class="align-middle">الطالب</th>
                <th rowspan="2" class="align-middle">الصف</th>
                <th rowspan="2" class="align-middle">الفصل</th>
                <th rowspan="2" class="align-middle">رقم ولي الأمر</th>
                <th colspan="${DB.subjects.length}" class="text-center">حالة المواد</th>
            </tr><tr>`;
            DB.subjects.forEach(s => thead += `<th>${s}</th>`);
            thead += `</tr>`;
            
            const tableHead = document.querySelector('#absTable thead');
            tableHead.innerHTML = thead;
            tableHead.className = 'table-light'; 

            let rows = '';
            let filteredStudents = DB.students.filter(s => (lvl === 'all' || s.level === lvl) && (cls === 'all' || s.class === cls));
            let sortedStudents = filteredStudents.sort((a,b) => (a.level + a.class).localeCompare(b.level + b.class));

            sortedStudents.forEach(s => {
                let hasDefect = false;
                let subCells = DB.subjects.map(sub => {
                    let g = DB.grades.find(gr => gr.studentId == s.id && gr.week === week && gr.subject === sub);
                    let cellStatus = '';
                    let cellClass = '';

                    if (!g) {
                        cellStatus = 'لم يرصد';
                        cellClass = 'bg-warning';
                        hasDefect = true;
                    } else if (g.absent) {
                        cellStatus = 'غائب';
                        cellClass = 'bg-danger text-white';
                        hasDefect = true;
                    } else {
                        let val = 0;
                        if (type === 'hw') {
                            let idx = parseInt(item) - 1;
                            val = g.hw ? g.hw[idx] : 0;
                        } else {
                            val = g.mock;
                        }
                        
                        if (val === 'abs' || val === 'غ') {
                            cellStatus = 'غائب';
                            cellClass = 'bg-danger text-white';
                            hasDefect = true;
                        } else if (!val || val == 0) {
                            cellStatus = 'لم يرصد';
                            cellClass = 'bg-warning';
                            hasDefect = true;
                        } else {
                            cellStatus = 'رصد';
                            cellClass = 'bg-success text-white'; 
                        }
                    }
                    if(cellStatus === 'رصد') return `<td class="${cellClass}"><i class="fas fa-check"></i></td>`;
                    return `<td class="${cellClass} fw-bold small">${cellStatus}</td>`;
                }).join('');

                if(hasDefect) {
                    rows += `<tr><td>${s.name}</td><td>${s.level}</td><td>${s.class}</td><td>${s.pPhone}</td>${subCells}</tr>`;
                }
            });

            if(rows === '') rows = '<tr><td colspan="100%" class="text-center p-3 text-muted">جميع الطلاب تم رصد درجاتهم ولا يوجد غائبين لهذا المحدد.</td></tr>';
            document.querySelector('#absTable tbody').innerHTML = rows;
        }

        // 2. Communication Logic
        window.updateCommStudents = function() {
            const lvl = document.getElementById('commLevel').value;
            const cls = document.getElementById('commClass').value;
            if(lvl && cls) {
                const students = DB.students.filter(s => s.level === lvl && s.class === cls);
                document.getElementById('commStudent').innerHTML = `<option value="">اختر الطالب</option>` + students.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
            }
        }

        window.initCommunicationForm = function() {
            document.getElementById('commDate').valueAsDate = new Date();
        }

        window.saveCommunication = function() {
            const date = document.getElementById('commDate').value;
            const studId = document.getElementById('commStudent').value;
            const action = document.getElementById('commAction').value;
            const reason = document.getElementById('commReason').value;
            const reply = document.getElementById('commReply').value;

            if(!studId || !reason) { alert('الرجاء اختيار الطالب وكتابة السبب'); return; }

            if(!DB.communications) DB.communications = [];
            DB.communications.push({
                id: Date.now(),
                studentId: studId,
                date: date,
                action: action,
                reason: reason,
                reply: reply
            });
            saveData('communications', DB.communications);
            
            // Reset form partly
            document.getElementById('commReason').value = '';
            document.getElementById('commReply').value = '';
        }

        // 3. Notifications Logic
        window.renderNotificationsSummary = function() {
            const lvl = document.getElementById('notifLevel').value;
            const cls = document.getElementById('notifClass').value;
            const search = document.getElementById('notifSearch').value.toLowerCase();

            if(!DB.communications) DB.communications = [];
            if(!DB.students) DB.students = [];

            let filteredComms = DB.communications.filter(c => {
                const s = DB.students.find(st => st.id == c.studentId);
                if(!s) return false; 
                
                const matchLvl = (lvl === 'all' || s.level === lvl);
                const matchCls = (cls === 'all' || s.class === cls);
                const matchName = (!search || s.name.toLowerCase().includes(search));
                return matchLvl && matchCls && matchName;
            });

            document.getElementById('totalNotifs').innerText = filteredComms.length;
            
            const rows = filteredComms.slice().reverse().map(c => {
                const s = DB.students.find(x => x.id == c.studentId);
                return `<tr>
                    <td>${c.date}</td>
                    <td class="fw-bold">${s.name}</td>
                    <td>${s.level}</td>
                    <td>${s.class}</td>
                    <td><span class="badge bg-secondary">${c.action}</span></td>
                    <td>${c.reason}</td>
                    <td>${c.reply || '-'}</td>
                </tr>`;
            }).join('');
            
            document.querySelector('#allNotifsTable tbody').innerHTML = rows || '<tr><td colspan="7" class="text-center text-muted">لا توجد إشعارات</td></tr>';
            document.getElementById('notifStudentSelect').innerHTML = `<option value="">اختر الطالب</option>` + DB.students.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
        }

        window.searchStudentForProfile = function() {
            const q = document.getElementById('notifSearchStudent').value.toLowerCase();
            const opts = DB.students.filter(s => s.name.toLowerCase().includes(q));
            document.getElementById('notifStudentSelect').innerHTML = `<option value="">اختر الطالب</option>` + opts.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
        }

        window.renderStudentProfile = function() {
            const sid = document.getElementById('notifStudentSelect').value;
            const container = document.getElementById('studentProfileContainer');
            if(!sid) { container.classList.add('d-none'); return; }
            
            container.classList.remove('d-none');
            const s = DB.students.find(x => x.id == sid);
            document.getElementById('profName').innerText = s.name;
            document.getElementById('profLevel').innerText = `الصف: ${s.level}`;
            document.getElementById('profClass').innerText = `الفصل: ${s.class}`;

            if(!DB.communications) DB.communications = [];
            const studComms = DB.communications.filter(c => c.studentId == sid).reverse();

            document.querySelector('#studentNotifTable tbody').innerHTML = studComms.map(c => 
                `<tr><td>${c.date}</td><td><span class="badge bg-secondary">${c.action}</span></td><td>${c.reason}</td><td>${c.reply || '-'}</td></tr>`
            ).join('');
        }

        // --- Comparison Logic ---
        window.populateComparisonDropdowns = function() {
            if(!DB.levels) DB.levels = []; if(!DB.classes) DB.classes = []; if(!DB.subjects) DB.subjects = [];
            document.getElementById('cmpLevel').innerHTML = `<option value="">اختر الصف</option>` + DB.levels.map(l=>`<option>${l}</option>`).join('');
            document.getElementById('cmpClass').innerHTML = `<option value="all">الكل / اختر الفصل</option>` + DB.classes.map(c=>`<option>${c}</option>`).join('');
            document.getElementById('cmpSubject').innerHTML = `<option value="">اختر المادة</option>` + DB.subjects.map(s=>`<option>${s}</option>`).join('');
            window.toggleComparisonInputs();
        }

        window.toggleComparisonInputs = function() {
            const mode = document.getElementById('cmpMode').value;
            const subDiv = document.getElementById('cmpSubjectDiv');
            if(mode === 'classes') {
                subDiv.style.display = 'block';
            } else {
                subDiv.style.display = 'none';
            }
        }

        window.drawComparisonChart = function() {
            const lvl = document.getElementById('cmpLevel').value;
            const cls = document.getElementById('cmpClass').value;
            const mode = document.getElementById('cmpMode').value;
            const specificSub = document.getElementById('cmpSubject').value;

            if(!lvl) { alert('الرجاء اختيار الصف الدراسي أولاً'); return; }
            if(mode === 'classes' && !specificSub) { alert('الرجاء اختيار المادة للمقارنة بين الفصول'); return; }

            // Data Prep
            let labels = [];
            let datasetData = [];
            let chartLabel = '';

            if(!DB.students) DB.students = [];
            if(!DB.grades) DB.grades = [];

            const getAvg = (studentList, subject) => {
                let sum = 0, count = 0;
                studentList.forEach(s => {
                    let grades = DB.grades.filter(g => g.studentId == s.id && g.subject === subject);
                    grades.forEach(g => {
                        sum += (g.hw.reduce((a,b)=>safeParse(a)+safeParse(b),0) + safeParse(g.mock));
                        count++;
                    });
                });
                return count > 0 ? Math.round(sum / count) : 0;
            };

            if (mode === 'subjects') {
                chartLabel = `مقارنة المواد - ${lvl} ${cls!=='all' ? '- '+cls : ''}`;
                labels = DB.subjects;
                let targetStudents = DB.students.filter(s => s.level === lvl && (cls === 'all' || s.class === cls));
                datasetData = DB.subjects.map(sub => getAvg(targetStudents, sub));

            } else if (mode === 'teachers') {
                chartLabel = `أداء المعلمين - ${lvl}`;
                let teachers = DB.users.filter(u => u.role === 'teacher');
                teachers.forEach(t => {
                    if(t.subject && t.classes) {
                        let tStudents = DB.students.filter(s => 
                            s.level === lvl && 
                            t.classes.includes(s.class) && 
                            (cls === 'all' || s.class === cls)
                        );
                        if(tStudents.length > 0) {
                            labels.push(t.fullName + ` (${t.subject})`);
                            datasetData.push(getAvg(tStudents, t.subject));
                        }
                    }
                });

            } else if (mode === 'classes') {
                chartLabel = `مقارنة الفصول - مادة ${specificSub} - ${lvl}`;
                let classesInLevel = [...new Set(DB.students.filter(s => s.level === lvl).map(s => s.class))].sort();
                labels = classesInLevel;
                datasetData = classesInLevel.map(c => {
                    let cStudents = DB.students.filter(s => s.level === lvl && s.class === c);
                    return getAvg(cStudents, specificSub);
                });
            }

            const ctx = document.getElementById('detailedComparisonChart');
            if(comparisonCharts.detailed) comparisonCharts.detailed.destroy();

            comparisonCharts.detailed = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'متوسط الدرجات',
                        data: datasetData,
                        backgroundColor: '#1e3c72',
                        borderColor: '#2a5298',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: { display: true, text: chartLabel, font: {size: 16} },
                        legend: { position: 'bottom' }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        // --- Bulk Sending Logic (Generic) ---
        window.bulkSendGrades = function(target) {
            const lvl = document.getElementById('grLevel').value;
            const cls = document.getElementById('grClass').value;
            const weekName = document.getElementById('grWeek').value;
            
            const students = DB.students.filter(s => (lvl==='all' || s.level===lvl) && (cls==='all' || s.class===cls));
            if(!students.length) return alert('لا يوجد طلاب لإرسال الرسائل');
            
            if(!confirm(`هل أنت متأكد من إرسال ${students.length} رسالة؟ (سيتم فتح نوافذ متتالية)`)) return;
            
            students.forEach((s, i) => {
                setTimeout(() => {
                    // Reusing the detailed WA logic but extracting message building is complex, 
                    // so we just call the function which opens the window.
                    // We modify sendDetailedWA to handle opening internally.
                    window.sendDetailedWA(s.id, weekName, target === 'student');
                }, i * 2500); // 2.5 seconds delay between each
            });
        }

        window.bulkSendHomework = function(target) {
            const lvl = document.getElementById('hwRepLevel').value;
            const cls = document.getElementById('hwRepClass').value;
            const week = document.getElementById('hwRepWeek').value;
            
            const students = DB.students.filter(s => (lvl==='all' || s.level===lvl) && (cls==='all' || s.class===cls));
            if(!students.length) return alert('لا يوجد طلاب');
            if(!confirm(`إرسال لـ ${students.length}؟`)) return;

            students.forEach((s, i) => {
                setTimeout(() => {
                    window.sendDetailedWA(s.id, week, target === 'student');
                }, i * 2500);
            });
        }

        window.bulkSendMocks = function(target) {
            const lvl = document.getElementById('mockRepLevel').value;
            const cls = document.getElementById('mockRepClass').value;
            const weekName = document.getElementById('mockRepWeek').value;
            
            const students = DB.students.filter(s => (lvl==='all' || s.level===lvl) && (cls==='all' || s.class===cls));
            if(!students.length) return alert('لا يوجد طلاب');
            if(!confirm(`إرسال لـ ${students.length}؟`)) return;

            students.forEach((s, i) => {
                setTimeout(() => {
                    window.sendDetailedWA(s.id, weekName, target === 'student');
                }, i * 2500);
            });
        }

        window.bulkSendAbsentees = function(target) {
            const lvl = document.getElementById('absLevel').value;
            const cls = document.getElementById('absClass').value;
            const weekName = document.getElementById('absWeek').value;
            
            // Only send to students who actually have absences/defects in this view?
            // The prompt implies "Send to all parents" button in Absentees section.
            // Usually, you only want to notify the absentees. 
            // I'll filter for students who have at least one 'abs' or missing grade in the current view logic.
            
            let students = DB.students.filter(s => (lvl==='all' || s.level===lvl) && (cls==='all' || s.class===cls));
            
            // Filter only those with issues
            let targetStudents = [];
            students.forEach(s => {
                let hasIssue = false;
                DB.subjects.forEach(sub => {
                    let g = DB.grades.find(gr => gr.studentId == s.id && gr.week === weekName && gr.subject === sub);
                    if(!g || g.absent || g.mock === 'abs' || g.mock === 'غ') hasIssue = true;
                    if(g && g.hw.some(h => h==='abs' || h==='غ')) hasIssue = true;
                });
                if(hasIssue) targetStudents.push(s);
            });

            if(!targetStudents.length) return alert('لا يوجد طلاب غائبين في هذا التحديد');
            if(!confirm(`إرسال لـ ${targetStudents.length} طالب لديهم غياب/نقص؟`)) return;

            targetStudents.forEach((s, i) => {
                setTimeout(() => {
                    // Use the same detailed report message as it contains absence info
                    window.sendDetailedWA(s.id, weekName, target === 'student');
                }, i * 2500);
            });
        }

    </script>
</body>
</html>